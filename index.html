<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mini OS v13</title>
<style>
:root{
  --fg:#0d1321; --mut:#5f6b7a;
  --glass:rgba(255,255,255,.92); --border:rgba(0,0,0,.12);
  --taskbarBg:rgba(255,255,255,.96); --winbarBg:rgba(255,255,255,.98);
  --accent:#2563eb; --radius:12px;
}
html,body{height:100%;margin:0;background:#eef3ff;color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
*{box-sizing:border-box}
button{font:inherit;cursor:pointer}
input,textarea{height:42px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--fg);padding:10px}

/* Wallpapers */
.wall{position:fixed;inset:0;z-index:0}
.wall.waves{background:linear-gradient(180deg,#ecf3ff,#ffffff)}
.wall.aurora{background:radial-gradient(70% 60% at 20% 20%,#c7f0ff 0%,#ffffff 50%),linear-gradient(160deg,#eaf7ff,#ffffff)}
.wall.ocean{background:linear-gradient(120deg,#a7f3d0,#e0f2fe,#f0f9ff)}
.wall.white{background:#ffffff}
.wall.black{background:#0b0b0b}
.wall.red{background:#ffe3e3}

/* Central clock */
#centralClock{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:120px;font-weight:900;color:#0d1321;
  background:rgba(255,255,255,.6); backdrop-filter:saturate(1.1) blur(8px);
  border:1px solid var(--border); border-radius:20px; padding:20px 40px;
  z-index:400;
}

/* Taskbar */
.taskbar{position:fixed;left:0;right:0;bottom:0;height:64px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;background:var(--taskbarBg);border-top:1px solid var(--border);z-index:900;padding:0 16px}
.start-btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:700}
.tb-center{display:flex;justify-content:center;gap:10px}
.tb-icon{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;border:1px solid var(--border);background:#fff}
.tb-right{display:flex;align-items:center;gap:10px}
.sys-chip{padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:#fff}

/* Start menu */
.start{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);width:min(960px,92vw);border-radius:16px;display:none;background:var(--glass);border:1px solid var(--border);z-index:950}
.start.show{display:block}
.start-top{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
.start-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:12px}
.tile{height:84px;border-radius:12px;border:1px solid var(--border);background:#fff;display:grid;place-items:center;font-weight:800}

/* Desktop */
.desktop{position:fixed;inset:0;z-index:100}
.icon-grid{position:absolute;left:24px;right:24px;top:24px;bottom:90px}
.desktop-icon{position:absolute;width:96px;height:96px;border-radius:14px;background:#fff;border:1px solid var(--border);display:grid;grid-template-rows:58px auto;place-items:center}
.icon-img{width:56px;height:56px;border-radius:12px;background:#fff;border:1px solid var(--border);display:grid;place-items:center}
.icon-label{font-weight:800;text-align:center;font-size:11px}

/* Windows */
.window{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1000px,94vw);height:min(680px,82vh);display:none;grid-template-rows:auto 1fr;background:var(--glass);border:1px solid var(--border);border-radius:12px;z-index:1100}
.window.show{display:grid}
.winbar{display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--winbarBg);border-bottom:1px solid var(--border)}
.win-title{font-weight:900}
.win-actions{display:flex;gap:6px}
.win-btn{min-width:32px;height:32px;border-radius:10px;border:1px solid var(--border);background:#fff;display:grid;place-items:center}
.content{padding:10px;overflow:auto}

/* Auth */
.auth-wrap{position:fixed;inset:0;z-index:1200;background:#ffffff;display:grid;place-items:center}
.auth-card{width:min(980px,92vw);display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
.auth-left{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px}
.auth-right{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;display:grid;place-items:center}
.auth-greet{font-size:28px;font-weight:900;margin-bottom:12px}
.auth-avatar{width:96px;height:96px;border-radius:50%;border:2px dashed #cbd5e1;background:#f8fafc;display:grid;place-items:center;margin-bottom:12px}
.auth-actions{display:flex;gap:10px;margin-top:14px}
.auth-btn{min-width:140px;height:42px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:700}
.auth-photo{width:360px;height:270px;border-radius:10px;border:2px dashed #cbd5e1;background:#f8fafc;display:grid;place-items:center;color:#64748b}

/* Toast */
#toast{position:fixed;right:20px;bottom:90px;background:#111;color:#fff;padding:12px 14px;border-radius:10px;z-index:2000;display:none;font-weight:800}
</style>
</head>
<body>

<!-- Wallpapers + central clock -->
<div id="wall" class="wall waves"></div>
<div id="centralClock"></div>

<!-- Taskbar -->
<div class="taskbar">
  <div class="start-btn" onclick="toggleStart()">–ü—É—Å–∫</div>
  <div class="tb-center" id="tbCenter"></div>
  <div class="tb-right">
    <div class="sys-chip" id="clockChip"></div>
    <div class="sys-chip" onclick="openWin('settings')">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
</div>

<!-- Start menu -->
<div id="start" class="start">
  <div class="start-top"><b>–ü—É—Å–∫</b><input id="startSearch" placeholder="–ü–æ–∏—Å–∫"/></div>
  <div class="start-grid" id="startGrid"></div>
</div>

<!-- Desktop -->
<div class="desktop"><div id="iconGrid" class="icon-grid"></div></div>

<!-- Windows -->
<div id="win-settings" class="window">
  <div class="winbar"><div class="win-title"><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('settings')">‚úï</div></div></div>
  <div class="content">
    <h3>–û–±–æ–∏</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="win-btn" onclick="setWall('waves')">Waves</button>
      <button class="win-btn" onclick="setWall('aurora')">Aurora</button>
      <button class="win-btn" onclick="setWall('ocean')">Ocean</button>
      <button class="win-btn" onclick="setWall('white')">White</button>
      <button class="win-btn" onclick="setWall('black')">Black</button>
      <button class="win-btn" onclick="setWall('red')">Red</button>
    </div>
    <h3 style="margin-top:16px">–¢–µ–º—ã</h3>
    <div style="display:flex;gap:8px">
      <button class="win-btn" onclick="applyTheme('light')">–°–≤–µ—Ç–ª–∞—è</button>
      <button class="win-btn" onclick="applyTheme('dark')">–¢—ë–º–Ω–∞—è</button>
      <button class="win-btn" onclick="applyTheme('blue')">–°–∏–Ω—è—è</button>
    </div>
    <h3 style="margin-top:16px">–ê–Ω–∏–º–∞—Ü–∏–∏</h3>
    <div style="display:flex;gap:8px">
      <button class="win-btn" onclick="toggleClockPulse()">–ü—É–ª—å—Å–∞—Ü–∏—è —á–∞—Å–æ–≤</button>
      <button class="win-btn" onclick="showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã')">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—Å—Ç</button>
    </div>
  </div>
</div>

<div id="win-terminal" class="window">
  <div class="winbar"><div class="win-title"><b>–¢–µ—Ä–º–∏–Ω–∞–ª</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('terminal')">‚úï</div></div></div>
  <div class="content" style="display:grid;grid-template-rows:1fr auto;gap:8px">
    <div id="termOut" style="border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff;overflow:auto"></div>
    <div style="display:flex;gap:8px">
      <input id="termIn" placeholder="–∫–æ–º–∞–Ω–¥–∞ (help)"/>
      <button class="win-btn" onclick="termRun()">Run</button>
    </div>
  </div>
</div>

<div id="win-notes" class="window">
  <div class="winbar"><div class="win-title"><b>–ó–∞–º–µ—Ç–∫–∏</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('notes')">‚úï</div></div></div>
  <div class="content">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="noteTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"/>
      <button class="win-btn" onclick="noteAdd()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <textarea id="noteBody" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏"></textarea>
    <div id="noteList" style="display:grid;gap:8px;margin-top:10px"></div>
  </div>
</div>

<div id="win-wifi" class="window">
  <div class="winbar"><div class="win-title"><b>Wi‚ÄëFi</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('wifi')">‚úï</div></div></div>
  <div class="content">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="wifiName" placeholder="SSID"/>
      <input id="wifiPass" placeholder="–ü–∞—Ä–æ–ª—å"/>
      <button class="win-btn" onclick="wifiSave()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="wifiList" style="display:grid;gap:8px"></div>
  </div>
</div>

<div id="win-chat" class="window">
  <div class="winbar"><div class="win-title"><b>–ß–∞—Ç</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('chat')">‚úï</div></div></div>
  <div class="content" style="display:grid;grid-template-rows:auto 1fr auto;gap:8px">
    <div style="display:flex;gap:8px">
      <input id="dmTo" placeholder="–ü–æ–ª—É—á–∞—Ç–µ–ª—å"/>
      <button class="win-btn" onclick="dmOpen()">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="chatView" style="border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff;overflow:auto"></div>
    <div style="display:flex;gap:8px">
      <input id="chatMsg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ"/>
      <button class="win-btn" onclick="sendChat()">‚ñ∂</button>
    </div>
  </div>
</div>

<div id="win-files" class="window">
  <div class="winbar"><div class="win-title"><b>–ü—Ä–æ–≤–æ–¥–Ω–∏–∫</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('files')">‚úï</div></div></div>
  <div class="content" style="display:grid;grid-template-columns:240px 1fr;gap:12px">
    <div id="fsSidebar" style="border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff"></div>
    <div style="border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <button class="win-btn" onclick="fsNewFolder()">üìÅ</button>
        <button class="win-btn" onclick="fsNewFile()">üìÑ</button>
        <button class="win-btn" onclick="fsDelete()">üóë</button>
      </div>
      <div id="fsMain"></div>
    </div>
  </div>
</div>

<div id="win-youtube" class="window">
  <div class="winbar"><div class="win-title"><b>YouTube</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('youtube')">‚úï</div></div></div>
  <div class="content">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="ytUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ YouTube"/>
      <button class="win-btn" onclick="ytPlay()">‚ñ∂</button>
    </div>
    <iframe id="ytFrame" width="100%" height="420" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  </div>
</div>

<div id="win-timer" class="window">
  <div class="winbar"><div class="win-title"><b>–¢–∞–π–º–µ—Ä</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('timer')">‚úï</div></div></div>
  <div class="content">
    <input id="timerSec" placeholder="–°–µ–∫—É–Ω–¥—ã" inputmode="numeric"/>
    <button class="win-btn" onclick="timerStart()">–°—Ç–∞—Ä—Ç</button>
    <button class="win-btn" onclick="timerStop()">–°—Ç–æ–ø</button>
    <div id="timerView" class="mut" style="margin-top:8px">–û–∂–∏–¥–∞–Ω–∏–µ‚Ä¶</div>
  </div>
</div>

<div id="win-media" class="window">
  <div class="winbar"><div class="win-title"><b>–ú–µ–¥–∏–∞</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('media')">‚úï</div></div></div>
  <div class="content">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="audioUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞—É–¥–∏–æ (mp3/ogg)"/>
      <button class="win-btn" onclick="mediaPlay()">‚ñ∂</button>
      <button class="win-btn" onclick="mediaStop()">‚ñ†</button>
    </div>
    <audio id="audioPlayer" crossorigin="anonymous"></audio>
    <canvas id="audioViz" width="800" height="220" style="width:100%;height:220px;border:1px solid var(--border);border-radius:10px;background:#0f172a"></canvas>
  </div>
</div>

<!-- Registration -->
<div id="auth" class="auth-wrap">
  <div class="auth-card">
    <div class="auth-left">
      <div class="auth-greet">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
      <div class="auth-avatar">üë§</div>
      <input id="authName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"/>
      <div class="auth-actions"><button class="auth-btn" onclick="authSubmit()">–í–æ–π—Ç–∏</button></div>
    </div>
    <div class="auth-right"><div id="authPhoto" class="auth-photo">–§–æ—Ç–æ</div></div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
/* State & storage */
const STORE_KEY='miniOS_v13';
let state={
  user:null, wall:'waves',
  notes:[], wifi:[], chat:[], dmWith:null,
  fs:{ path:['Desktop'], tree:{
    Desktop:{type:'folder',items:{}},
    Documents:{type:'folder',items:{'Welcome.txt':{type:'file',content:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Mini OS v13'}}},
    Scripts:{type:'folder',items:{}},
    Media:{type:'folder',items:{}}
  }}
};
function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }
function load(){ try{ const raw=localStorage.getItem(STORE_KEY); if(raw){ state=Object.assign(state, JSON.parse(raw)); } }catch(e){} }
load();

/* Apps & desktop icons */
const baseApps=[
  {id:'settings',label:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏',icon:'‚öô',open:()=>openWin('settings')},
  {id:'terminal',label:'–¢–µ—Ä–º–∏–Ω–∞–ª',icon:'>_',open:()=>openWin('terminal')},
  {id:'notes',label:'–ó–∞–º–µ—Ç–∫–∏',icon:'üìù',open:()=>openWin('notes')},
  {id:'wifi',label:'Wi‚ÄëFi',icon:'üì∂',open:()=>openWin('wifi')},
  {id:'chat',label:'–ß–∞—Ç',icon:'üí¨',open:()=>openWin('chat')},
  {id:'files',label:'–ü—Ä–æ–≤–æ–¥–Ω–∏–∫',icon:'üóÇ',open:()=>openWin('files')},
  {id:'youtube',label:'YouTube',icon:'‚ñ∂Ô∏è',open:()=>openWin('youtube')},
  {id:'timer',label:'–¢–∞–π–º–µ—Ä',icon:'‚è∞',open:()=>openWin('timer')},
  {id:'media',label:'–ú–µ–¥–∏–∞',icon:'üéµ',open:()=>openWin('media')}
];
let desktopIcons=[
  {id:'settings',name:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏',icon:'‚öô'},{id:'terminal',name:'–¢–µ—Ä–º–∏–Ω–∞–ª',icon:'>_'},
  {id:'notes',name:'–ó–∞–º–µ—Ç–∫–∏',icon:'üìù'},{id:'wifi',name:'Wi‚ÄëFi',icon:'üì∂'},
  {id:'chat',name:'–ß–∞—Ç',icon:'üí¨'},{id:'files',name:'–ü—Ä–æ–≤–æ–¥–Ω–∏–∫',icon:'üóÇ'},
  {id:'youtube',name:'YouTube',icon:'‚ñ∂Ô∏è'},{id:'timer',name:'–¢–∞–π–º–µ—Ä',icon:'‚è∞'},
  {id:'media',name:'–ú–µ–¥–∏–∞',icon:'üéµ'}
];

/* Builders */
function toggleStart(){document.getElementById('start').classList.toggle('show');}
function buildStartMenu(){
  const grid=document.getElementById('startGrid'); grid.innerHTML='';
  baseApps.forEach(a=>{
    const t=document.createElement('div'); t.className='tile'; t.textContent=a.label; t.onclick=a.open;
    grid.appendChild(t);
  });
}
function buildTaskbarCenter(){
  const c=document.getElementById('tbCenter'); c.innerHTML='';
  baseApps.forEach(a=>{
    const i=document.createElement('div'); i.className='tb-icon'; i.textContent=a.icon; i.onclick=a.open;
    c.appendChild(i);
  });
}
function renderDesktop(){
  const g=document.getElementById('iconGrid'); g.innerHTML='';
  desktopIcons.forEach((d,idx)=>{
    const el=document.createElement('div'); el.className='desktop-icon';
    const col = idx % 6; const row = Math.floor(idx/6); // –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞
    el.style.top=(row*110)+'px'; el.style.left=(20+col*120)+'px';
    el.onclick=()=>{const app=baseApps.find(a=>a.id===d.id); if(app) app.open();};
    el.innerHTML=`<div class="icon-img">${d.icon}</div><div class="icon-label">${d.name}</div>`;
    g.appendChild(el);
  });
}

/* Windows control */
function openWin(id){document.getElementById('win-'+id).classList.add('show');}
function closeWin(id){document.getElementById('win-'+id).classList.remove('show');}

/* Wallpapers & themes */
function setWall(name){ state.wall=name; document.getElementById('wall').className='wall '+name; save(); showToast('–û–±–æ–∏: '+name); }
function applyTheme(name){
  if(name==='dark'){
    document.documentElement.style.setProperty('--taskbarBg','rgba(24,24,27,.85)');
    document.documentElement.style.setProperty('--winbarBg','rgba(24,24,27,.92)');
    document.documentElement.style.setProperty('--fg','#e5e7eb'); document.body.style.background='#0b0b0b';
  }else if(name==='blue'){
    document.documentElement.style.setProperty('--accent','#2563eb'); document.body.style.background='#eaf2ff';
  }else{
    document.documentElement.style.setProperty('--taskbarBg','rgba(255,255,255,.96)');
    document.documentElement.style.setProperty('--winbarBg','rgba(255,255,255,.98)');
    document.documentElement.style.setProperty('--fg','#0d1321'); document.body.style.background='#eef3ff';
  }
  showToast('–¢–µ–º–∞: '+name); save();
}
function toggleClockPulse(){
  const el=document.getElementById('centralClock');
  el.style.boxShadow = el.style.boxShadow ? '' : '0 0 0 12px rgba(37,99,235,.12)';
}

/* Clock & toast */
function updateCentralClock(){
  const d=new Date();
  const hh=String(d.getHours()).padStart(2,'0');
  const mm=String(d.getMinutes()).padStart(2,'0');
  document.getElementById('centralClock').textContent=`${hh}:${mm}`;
}
setInterval(updateCentralClock,1000); updateCentralClock();
function updateClockChip(){ document.getElementById('clockChip').textContent=new Date().toLocaleTimeString(); }
setInterval(updateClockChip,1000); updateClockChip();
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>{t.style.display='none';},3000); }

/* Terminal */
function termPrint(s){ const out=document.getElementById('termOut'); const div=document.createElement('div'); div.textContent=s; out.appendChild(div); out.scrollTop=out.scrollHeight; }
function termRun(){
  const v=document.getElementById('termIn').value.trim(); if(!v) return;
  const [cmd,...rest]=v.split(' '); const arg=rest.join(' ');
  if(cmd==='help'){ termPrint('–ö–æ–º–∞–Ω–¥—ã: wall <waves|aurora|ocean|white|black|red>, open <app>, timer <sec>, youtube <url>'); }
  else if(cmd==='wall'){ setWall(arg||'waves'); termPrint('–û–±–æ–∏: '+(arg||'waves')); }
  else if(cmd==='open'){ const app=baseApps.find(a=>a.id===arg); if(app){ app.open(); termPrint('–û—Ç–∫—Ä—ã—Ç–æ: '+arg); } else termPrint('–ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è '+arg); }
  else if(cmd==='timer'){ document.getElementById('timerSec').value=arg; openWin('timer'); timerStart(); termPrint('–¢–∞–π–º–µ—Ä: '+arg+'—Å'); }
  else if(cmd==='youtube'){ openWin('youtube'); document.getElementById('ytUrl').value=arg; ytPlay(); termPrint('YouTube: '+arg); }
  else{ termPrint('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ: '+cmd); }
  document.getElementById('termIn').value='';
}

/* Notes */
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function renderNotes(){
  const root=document.getElementById('noteList'); if(!root) return; root.innerHTML='';
  state.notes.forEach((n,i)=>{
    const card=document.createElement('div'); card.style.border='1px solid var(--border)'; card.style.borderRadius='10px'; card.style.padding='10px'; card.style.background='#fff';
    card.innerHTML=`<div><b>${escapeHtml(n.title)}</b></div><div>${escapeHtml(n.body)}</div>`;
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
    const edit=document.createElement('button'); edit.className='win-btn'; edit.textContent='‚úé'; edit.onclick=()=>{ const t=prompt('–ó–∞–≥–æ–ª–æ–≤–æ–∫', n.title)||n.title; const b=prompt('–¢–µ–∫—Å—Ç', n.body)||n.body; state.notes[i]={title:t,body:b,ts:n.ts}; save(); renderNotes(); };
    const del=document.createElement('button'); del.className='win-btn'; del.textContent='üóë'; del.onclick=()=>{ state.notes.splice(i,1); save(); renderNotes(); };
    actions.appendChild(edit); actions.appendChild(del); card.appendChild(actions);
    root.appendChild(card);
  });
}
function noteAdd(){
  const title=document.getElementById('noteTitle').value.trim();
  const body=document.getElementById('noteBody').value.trim();
  if(!title||!body){ showToast('–ó–∞–ø–æ–ª–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç'); return; }
  state.notes.unshift({title,body,ts:Date.now()}); document.getElementById('noteTitle').value=''; document.getElementById('noteBody').value='';
  save(); renderNotes();
}

/* Wi-Fi */
function wifiRender(){
  const root=document.getElementById('wifiList'); if(!root) return; root.innerHTML='';
  if(!state.wifi.length){ root.innerHTML='<div class="mut">–°–µ—Ç–µ–π –Ω–µ—Ç</div>'; return; }
  state.wifi.forEach((w,i)=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='10px'; row.style.background='#fff';
    row.innerHTML=`<div>üì∂ ${escapeHtml(w.ssid)}</div><div>${escapeHtml(w.pass)}</div>`;
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
    const edit=document.createElement('button'); edit.className='win-btn'; edit.textContent='‚úé'; edit.onclick=()=>{ const ssid=prompt('SSID', w.ssid)||w.ssid; const pass=prompt('–ü–∞—Ä–æ–ª—å', w.pass)||w.pass; state.wifi[i]={ssid,pass}; save(); wifiRender(); };
    const del=document.createElement('button'); del.className='win-btn'; del.textContent='üóë'; del.onclick=()=>{ state.wifi.splice(i,1); save(); wifiRender(); };
    actions.appendChild(edit); actions.appendChild(del); row.appendChild(actions);
    root.appendChild(row);
  });
}
function wifiSave(){
  const ssid=document.getElementById('wifiName').value.trim(); const pass=document.getElementById('wifiPass').value.trim();
  if(!ssid||!pass){ showToast('SSID –∏ –ø–∞—Ä–æ–ª—å'); return; }
  state.wifi.push({ssid,pass}); document.getElementById('wifiName').value=''; document.getElementById('wifiPass').value='';
  save(); wifiRender();
}

/* Chat */
function dmOpen(){ const to=document.getElementById('dmTo').value.trim(); if(!to){ showToast('–£–∫–∞–∂–∏ –∏–º—è'); return; } state.dmWith=to; save(); renderChat(); }
function renderChat(){
  const view=document.getElementById('chatView'); if(!view) return; view.innerHTML='';
  const withName=state.dmWith||'–ì–ª–æ–±–∞–ª—å–Ω—ã–π'; const header=document.createElement('div'); header.className='mut'; header.textContent='–ß–∞—Ç: '+withName; view.appendChild(header);
  (state.chat||[]).filter(m=>!state.dmWith || m.to===state.dmWith).forEach(m=>{
    const d=new Date(m.ts).toLocaleTimeString();
    const row=document.createElement('div'); row.style.margin='6px 0';
    row.innerHTML=`<div class="mut">${d} ¬∑ ${escapeHtml(m.from)}${m.to?(' ‚Üí '+escapeHtml(m.to)):''}</div><div>${escapeHtml(m.text)}</div>`;
    view.appendChild(row);
  });
  view.scrollTop=view.scrollHeight;
}
function sendChat(){
  const inp=document.getElementById('chatMsg'); const text=inp.value.trim(); if(!text) return;
  state.chat.push({from:state.user||'User', to:state.dmWith||null, text, ts:Date.now()}); inp.value=''; save(); renderChat();
}

/* Explorer */
function fsNodeAtPath(){
  let node=state.fs.tree;
  for(const seg of state.fs.path){
    if(!node[seg]) return {};
    node = node[seg].type==='folder' ? node[seg].items : node[seg];
  }
  return node;
}
function fsRender(){
  const sidebar=document.getElementById('fsSidebar'); const main=document.getElementById('fsMain'); if(!sidebar||!main) return;
  sidebar.innerHTML='';
  Object.keys(state.fs.tree).forEach(name=>{
    const btn=document.createElement('div'); btn.textContent=name; btn.style.padding='8px'; btn.style.borderRadius='8px'; btn.style.cursor='pointer';
    btn.onclick=()=>{ state.fs.path=[name]; fsRender(); };
    sidebar.appendChild(btn);
  });
  main.innerHTML='';
  const items=fsNodeAtPath();
  Object.keys(items).forEach(name=>{
    const it=items[name];
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.borderBottom='1px solid rgba(0,0,0,.08)';
    const left=document.createElement('div'); left.textContent=(it.type==='folder'?'üìÅ ':'üìÑ ')+name;
    const right=document.createElement('div');
    const openBtn=document.createElement('button'); openBtn.className='win-btn'; openBtn.textContent='–û—Ç–∫—Ä—ã—Ç—å';
    openBtn.onclick=()=>{ if(it.type==='folder'){ state.fs.path.push(name); fsRender(); } else { alert(it.content||'–ü—É—Å—Ç–æ'); } };
    const renameBtn=document.createElement('button'); renameBtn.className='win-btn'; renameBtn.textContent='‚úé';
    renameBtn.onclick=()=>{
      const newName=prompt('–ù–æ–≤–æ–µ –∏–º—è', name); if(!newName||newName===name) return;
      if(items[newName]){ showToast('–ò–º—è –∑–∞–Ω—è—Ç–æ'); return; }
      items[newName]=it; delete items[name]; save(); fsRender();
    };
    const delBtn=document.createElement('button'); delBtn.className='win-btn'; delBtn.textContent='üóë';
    delBtn.onclick=()=>{ delete items[name]; save(); fsRender(); };
    right.appendChild(openBtn); right.appendChild(renameBtn); right.appendChild(delBtn);
    row.appendChild(left); row.appendChild(right); main.appendChild(row);
  });
  if(state.fs.path.length>1){
    const up=document.createElement('div'); up.style.marginTop='8px';
    const btn=document.createElement('button'); btn.className='win-btn'; btn.textContent='‚¨Ö –ù–∞–∑–∞–¥';
    btn.onclick=()=>{ state.fs.path.pop(); fsRender(); };
    up.appendChild(btn); main.appendChild(up);
  }
}
function fsNewFolder(){
  const name=prompt('–ò–º—è –ø–∞–ø–∫–∏','–ù–æ–≤–∞—è –ø–∞–ø–∫–∞'); if(!name) return;
  const items=fsNodeAtPath(); if(items[name]){ showToast('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
  items[name]={type:'folder', items:{}}; save(); fsRender();
}
function fsNewFile(){
  const name=prompt('–ò–º—è —Ñ–∞–π–ª–∞','–ù–æ–≤—ã–π —Ñ–∞–π–ª.txt'); if(!name) return;
  const items=fsNodeAtPath(); if(items[name]){ showToast('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
  const content=prompt('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ',''); items[name]={type:'file', content:content||''}; save(); fsRender();
}
function fsDelete(){
  const name=prompt('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç (–∏–º—è)',''); if(!name) return;
  const items=fsNodeAtPath(); if(!items[name]){ showToast('–ù–µ –Ω–∞–π–¥–µ–Ω–æ'); return; }
  delete items[name]; save(); fsRender();
}

/* Multimedia */
function ytPlay(){
  const url=document.getElementById('ytUrl').value.trim(); if(!url){ showToast('–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É'); return; }
  let embed=url;
  if(url.includes('watch')) embed=url.replace('watch?v=','embed/');
  else if(url.includes('youtu.be')) embed='https://www.youtube.com/embed/'+url.split('/').pop();
  document.getElementById('ytFrame').src=embed;
}
let timerId=null, timerEnd=0;
function timerStart(){
  const sec=parseInt(document.getElementById('timerSec').value,10); if(!sec||sec<=0){ showToast('–£–∫–∞–∂–∏ —Å–µ–∫—É–Ω–¥—ã'); return; }
  timerStop(); timerEnd=Date.now()+sec*1000;
  timerId=setInterval(()=>{
    const left=Math.max(0,Math.floor((timerEnd-Date.now())/1000));
    document.getElementById('timerView').textContent=left>0?`–û—Å—Ç–∞–ª–æ—Å—å: ${left} —Å–µ–∫.`:'–ì–æ—Ç–æ–≤–æ';
    if(left<=0){ timerStop(); showToast('‚è∞ –¢–∞–π–º–µ—Ä –æ–∫–æ–Ω—á–µ–Ω'); }
  },200);
}
function timerStop(){ if(timerId){ clearInterval(timerId); timerId=null; } }
let audioCtx=null, analyser=null, sourceNode=null, vizId=null;
function mediaPlay(){
  const url=document.getElementById('audioUrl').value.trim(); if(!url){ showToast('–£–∫–∞–∂–∏ URL'); return; }
  const audio=document.getElementById('audioPlayer'); audio.src=url; audio.play().catch(()=>{});
  if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
  if(sourceNode) sourceNode.disconnect();
  sourceNode=audioCtx.createMediaElementSource(audio);
  analyser=audioCtx.createAnalyser(); analyser.fftSize=1024;
  sourceNode.connect(analyser); analyser.connect(audioCtx.destination);
  startViz();
}
function mediaStop(){ const audio=document.getElementById('audioPlayer'); audio.pause(); audio.currentTime=0; stopViz(); }
function startViz(){
  const canvas=document.getElementById('audioViz'); const ctx=canvas.getContext('2d');
  const bufferLength=analyser.frequencyBinCount; const data=new Uint8Array(bufferLength);
  function draw(){
    vizId=requestAnimationFrame(draw);
    analyser.getByteFrequencyData(data);
    ctx.fillStyle='#0f172a'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const barWidth=(canvas.width/bufferLength)*2.5; let x=0;
    for(let i=0;i<bufferLength;i++){
      const barHeight=data[i]/2; ctx.fillStyle=`rgb(${barHeight+100},50,150)`;
      ctx.fillRect(x,canvas.height-barHeight,barWidth,barHeight); x+=barWidth+1;
    }
  } draw();
}
function stopViz(){ if(vizId){ cancelAnimationFrame(vizId); vizId=null; } }

/* Registration */
function authSubmit(){
  const name=document.getElementById('authName').value.trim();
  if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
  state.user=name; save();
  document.getElementById('auth').style.display='none';
  showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+name+'!');
}
function randomPhoto(){
  const p=document.getElementById('authPhoto');
  const imgs=['üåÑ','üèû','üåÜ','üåå','üåâ','üèñ'];
  p.textContent=imgs[Math.floor(Math.random()*imgs.length)];
}
randomPhoto();

/* Sync across tabs */
window.addEventListener('storage', (e)=>{
  if(e.key===STORE_KEY){
    load(); renderNotes(); wifiRender(); renderChat(); fsRender();
  }
});

/* Init */
(function init(){
  setWall(state.wall||'waves');
  buildStartMenu(); buildTaskbarCenter(); renderDesktop();
  renderNotes(); wifiRender(); renderChat(); fsRender();
})();
</script>
</body>
</html>
<style>
/* Creator badge */
.creator-badge{
  display:inline-flex; align-items:center; gap:6px;
  background:#fff8db; color:#b08900; border:1px solid #f0d96a;
  padding:4px 8px; border-radius:999px; font-weight:800; font-size:12px;
}

/* Orbit avatar (yellow ring) */
.creator-orbit{
  position:relative; width:28px; height:28px; border-radius:50%; background:#fff;
  display:inline-grid; place-items:center; margin-left:8px;
}
.creator-orbit::before{
  content:''; position:absolute; inset:-3px; border:2px solid #ffd000; border-radius:50%;
  animation:orbitRotate 2.2s linear infinite;
}
@keyframes orbitRotate{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
</style><script>
/* ===== Admin & secrets state ===== */
if (typeof state==='undefined') window.state={};
state.userRole = state.userRole || 'user';       // 'user' | 'admin' | 'creator'
state.isCreator = state.isCreator ?? true;       // —Ç–≤–æ—è –º–µ—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è (–º–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å)
state.pinEnabled = state.pinEnabled ?? false;
state.pinCode = state.pinCode ?? '';
state.secretApps = state.secretApps || [];       // {id,label,icon}
state.secretScripts = state.secretScripts || [   // –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ ¬´—Å–∫—Ä–∏–ø—Ç—ã¬ª
  {id:'hello', title:'Hello world', desc:'–ü–µ—á–∞—Ç—å –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª'},
  {id:'spark', title:'Spark', desc:'–ü–æ–∫–∞–∑ —Ç–æ—Å—Ç–∞ –∏ —Å–º–µ–Ω–∞ —Ç–µ–º—ã'}
];
save?.();
</script><script>
/* ===== Create Admin Panel & Secrets windows ===== */
document.body.insertAdjacentHTML('beforeend', `
  <div id="win-admin" class="window">
    <div class="winbar"><div class="win-title"><b>–ê–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å</b></div>
      <div class="win-actions"><div class="win-btn" onclick="closeWin('admin')">‚úï</div></div>
    </div>
    <div class="content" style="display:grid;grid-template-columns:300px 1fr;gap:12px">
      <div style="border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff">
        <h4>–°—Ç–∞—Ç—É—Å</h4>
        <div id="adminStatus" class="mut"></div>
        <h4>PIN</h4>
        <div style="display:flex;gap:8px;align-items:center">
          <label><input type="checkbox" id="pinEnable"> –í–∫–ª—é—á–∏—Ç—å PIN</label>
          <input id="pinValue" placeholder="PIN (4-8 —Ü–∏—Ñ—Ä)" style="width:140px"/>
          <button class="win-btn" onclick="pinSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <h4 style="margin-top:12px">–°–æ–∑–¥–∞—Ç–µ–ª—å</h4>
        <label><input type="checkbox" id="creatorToggle"> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ—Ç–∫—É [–°–æ–∑–¥–∞—Ç–µ–ª—å]</label>
      </div>
      <div style="border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff">
        <h4>–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h4>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="secretId" placeholder="id" style="width:140px"/>
          <input id="secretLabel" placeholder="label" style="width:180px"/>
          <input id="secretIcon" placeholder="icon (emoji)" style="width:100px"/>
          <button class="win-btn" onclick="secretAdd()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="secretList" style="display:grid;gap:8px"></div>
        <h4 style="margin-top:12px">–°–µ–∫—Ä–µ—Ç–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã</h4>
        <div id="scriptsList" style="display:grid;gap:8px"></div>
      </div>
    </div>
  </div>

  <div id="win-secret" class="window">
    <div class="winbar"><div class="win-title"><b>–°–µ–∫—Ä–µ—Ç—ã</b></div>
      <div class="win-actions"><div class="win-btn" onclick="closeWin('secret')">‚úï</div></div>
    </div>
    <div class="content">
      <div id="secretRunArea" class="mut">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –≤ –∞–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª–∏</div>
    </div>
  </div>
`);
</script><script>
/* ===== Bind Admin app (visible only for admin/creator) ===== */
(function bindAdmin(){
  const showAdmin = (state.userRole==='admin' || state.userRole==='creator');
  if (showAdmin && !baseApps.find(a=>a.id==='admin')){
    baseApps.push({id:'admin',label:'–ê–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å',icon:'üõ°',open:()=>openWin('admin')});
    baseApps.push({id:'secret',label:'–°–µ–∫—Ä–µ—Ç—ã',icon:'üóù',open:()=>openWin('secret')});
    buildStartMenu?.(); buildTaskbarCenter?.();
  }
  // Desktop icons placing (optional)
  if (showAdmin && !desktopIcons.find(i=>i.id==='admin')){
    desktopIcons.push({id:'admin',name:'–ê–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å',icon:'üõ°'});
    desktopIcons.push({id:'secret',name:'–°–µ–∫—Ä–µ—Ç—ã',icon:'üóù'});
    renderDesktop?.();
  }
})();

/* ===== Enhance Settings dynamically (PIN section quick link) ===== */
(function enhanceSettingsUI(){
  const settings = document.querySelector('#win-settings .content');
  if (!settings || settings.dataset.adminEnhanced) return;
  const block = document.createElement('div');
  block.style.marginTop='16px';
  block.innerHTML = `
    <h3>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="win-btn" onclick="openWin('admin')">–û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å</button>
      <span class="mut">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PIN, —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏ –º–µ—Ç–æ–∫ —Å–æ–∑–¥–∞—Ç–µ–ª—è</span>
    </div>
  `;
  settings.appendChild(block);
  settings.dataset.adminEnhanced='1';
})();
</script><script>
/* ===== Admin panel logic ===== */
function adminRender(){
  const st = document.getElementById('adminStatus');
  if (st) st.textContent = `–†–æ–ª—å: ${state.userRole} ¬∑ PIN: ${state.pinEnabled ? '–≤–∫–ª—é—á—ë–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`;
  const pe = document.getElementById('pinEnable'); const pv = document.getElementById('pinValue');
  if (pe) pe.checked = !!state.pinEnabled;
  if (pv) pv.value = state.pinCode || '';
  const ct = document.getElementById('creatorToggle'); if (ct) ct.checked = !!state.isCreator;

  const list = document.getElementById('secretList'); if (list){ list.innerHTML='';
    state.secretApps.forEach((app,idx)=>{
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
      row.style.border='1px solid var(--border)'; row.style.borderRadius='10px'; row.style.padding='8px'; row.style.background='#fff';
      row.innerHTML = `<div>${app.icon||'üóù'} ${app.label} <span class="mut">(${app.id})</span></div>`;
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
      const openBtn = document.createElement('button'); openBtn.className='win-btn'; openBtn.textContent='–û—Ç–∫—Ä—ã—Ç—å';
      openBtn.onclick = ()=> openSecretApp(app.id);
      const delBtn = document.createElement('button'); delBtn.className='win-btn'; delBtn.textContent='üóë';
      delBtn.onclick = ()=>{ state.secretApps.splice(idx,1); save(); adminRender(); };
      actions.appendChild(openBtn); actions.appendChild(delBtn); row.appendChild(actions);
      list.appendChild(row);
    });
  }
  const sList = document.getElementById('scriptsList'); if (sList){ sList.innerHTML='';
    state.secretScripts.forEach(scr=>{
      const card = document.createElement('div');
      card.style.border='1px solid var(--border)'; card.style.borderRadius='10px';
      card.style.padding='8px'; card.style.background='#fff';
      card.innerHTML = `<b>${scr.title}</b><div class="mut">${scr.desc}</div>`;
      const run = document.createElement('button'); run.className='win-btn'; run.textContent='–ó–∞–ø—É—Å—Ç–∏—Ç—å';
      run.onclick = ()=> secretRun(scr.id);
      card.appendChild(run); sList.appendChild(card);
    });
  }
}
function openSecretApp(id){
  // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ "–°–µ–∫—Ä–µ—Ç—ã" —Å –º–µ—Ç–∫–æ–π –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  openWin('secret');
  const area = document.getElementById('secretRunArea');
  area.textContent = `–°–µ–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ: ${id}`;
}
function secretAdd(){
  const id = document.getElementById('secretId').value.trim();
  const label = document.getElementById('secretLabel').value.trim();
  const icon = document.getElementById('secretIcon').value.trim() || 'üóù';
  if (!id || !label){ showToast('–£–∫–∞–∂–∏ id –∏ label'); return; }
  state.secretApps.push({id,label,icon}); save(); adminRender(); showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
}
function secretRun(id){
  openWin('secret');
  const area = document.getElementById('secretRunArea');
  if (id==='hello'){ area.textContent = 'Hello from secret script!'; showToast('–°–∫—Ä–∏–ø—Ç: hello'); }
  else if (id==='spark'){ applyTheme?.('blue'); showToast('Spark –ø—Ä–∏–º–µ–Ω–∏–ª —Å–∏–Ω—é—é —Ç–µ–º—É'); }
  else { area.textContent = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–∫—Ä–∏–ø—Ç: '+id; }
}
function pinSave(){
  const enabled = document.getElementById('pinEnable').checked;
  const code = document.getElementById('pinValue').value.trim();
  if (enabled && (!code || code.length<4 || code.length>8 || !/^\d+$/.test(code))){
    showToast('PIN: 4-8 —Ü–∏—Ñ—Ä'); return;
  }
  state.pinEnabled = enabled; state.pinCode = enabled ? code : '';
  save(); adminRender(); showToast('PIN –æ–±–Ω–æ–≤–ª—ë–Ω');
}
document.getElementById('win-admin')?.addEventListener('transitionend', adminRender);
adminRender();

/* ===== PIN guard for sensitive apps ===== */
const sensitiveIds = new Set(['files','notes','chat','wifi','secret','admin']);
function guardOpen(appId, openFn){
  if (!state.pinEnabled || !sensitiveIds.has(appId)) return openFn();
  const pin = prompt('–í–≤–µ–¥–∏—Ç–µ PIN'); if (pin===state.pinCode){ return openFn(); }
  showToast('–ù–µ–≤–µ—Ä–Ω—ã–π PIN'); return;
}
// Rebind open functions to guard
baseApps.forEach(a=>{
  const original = a.open;
  a.open = ()=> guardOpen(a.id, original);
});
buildStartMenu?.(); buildTaskbarCenter?.();
</script><script>
/* ===== Override renderChat to add creator badge & orbit avatar ===== */
const prevRenderChat = typeof renderChat==='function' ? renderChat : null;
function renderChat(){
  const view=document.getElementById('chatView'); if(!view) return; view.innerHTML='';
  const withName=state.dmWith||'–ì–ª–æ–±–∞–ª—å–Ω—ã–π';
  const header=document.createElement('div'); header.className='mut';
  header.innerHTML = `–ß–∞—Ç: ${withName}
    ${state.isCreator ? `<span class="creator-badge">–°–æ–∑–¥–∞—Ç–µ–ª—å <span class="creator-orbit">üë§</span></span>` : ''}`;
  view.appendChild(header);

  (state.chat||[]).filter(m=>!state.dmWith || m.to===state.dmWith).forEach(m=>{
    const d=new Date(m.ts).toLocaleTimeString();
    const isCreatorMsg = state.isCreator && m.from===(state.user||'User');
    const row=document.createElement('div'); row.style.margin='8px 0';
    row.innerHTML = `
      <div class="mut">
        ${d} ¬∑ ${isCreatorMsg ? `<span class="creator-badge">–°–æ–∑–¥–∞—Ç–µ–ª—å</span>` : ''} ${m.from}${m.to?(' ‚Üí '+m.to):''}
      </div>
      <div>${m.text}</div>
    `;
    view.appendChild(row);
  });
  view.scrollTop=view.scrollHeight;
}
if (prevRenderChat) { /* keep signature, but we fully override with badge support */ }
renderChat();
</script><script>
/* ===== Admin terminal commands ===== */
const prevTermRun = typeof termRun==='function' ? termRun : null;
function termRun(){
  const v=document.getElementById('termIn')?.value.trim(); if(!v){ prevTermRun?.(); return; }
  const [cmd,...rest]=v.split(' '); const arg=rest.join(' ');

  // Admin and power commands
  if (cmd==='apps'){ termPrint?.('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è: '+baseApps.map(a=>a.id).join(', ')); }
  else if (cmd==='theme'){ applyTheme?.(arg||'light'); termPrint?.('–¢–µ–º–∞: '+(arg||'light')); }
  else if (cmd==='clock'){
    if(arg==='off'){ document.getElementById('centralClock').style.display='none'; termPrint?.('–ß–∞—Å—ã —Å–∫—Ä—ã—Ç—ã'); }
    else { document.getElementById('centralClock').style.display='block'; termPrint?.('–ß–∞—Å—ã –≤–∫–ª—é—á–µ–Ω—ã'); }
  }
  else if (cmd==='user'){ state.user=arg||'User'; save?.(); termPrint?.('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: '+state.user); }
  else if (cmd==='role'){ state.userRole = arg||'admin'; save?.(); termPrint?.('–†–æ–ª—å: '+state.userRole); bindAdmin?.(); }
  else if (cmd==='creator'){ state.isCreator = (arg!=='off'); save?.(); termPrint?.('–ú–µ—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è: '+(state.isCreator?'on':'off')); renderChat?.(); }
  else if (cmd==='pin'){
    if(arg.startsWith('on')){ const code = arg.split(' ')[1]||prompt('PIN (4-8 —Ü–∏—Ñ—Ä)',''); document.getElementById('pinValue').value=code||''; document.getElementById('pinEnable').checked=true; pinSave(); termPrint?.('PIN –≤–∫–ª—é—á—ë–Ω'); }
    else { document.getElementById('pinEnable').checked=false; document.getElementById('pinValue').value=''; pinSave(); termPrint?.('PIN –≤—ã–∫–ª—é—á–µ–Ω'); }
  }
  else if (cmd==='secret'){
    const sub = rest[0]||'list';
    if (sub==='list'){ termPrint?.('–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: '+(state.secretApps.map(x=>x.id).join(', ')||'–Ω–µ—Ç')); }
    else if (sub==='add'){ const id=rest[1], label=rest[2]||id, icon=rest[3]||'üóù'; if(!id){ termPrint?.('secret add <id> <label?> <icon?>'); }
      else { state.secretApps.push({id,label,icon}); save?.(); adminRender?.(); termPrint?.('–î–æ–±–∞–≤–ª–µ–Ω–æ: '+id); } }
    else if (sub==='run'){ const id=rest[1]; if(!id){ termPrint?.('secret run <scriptId>'); }
      else { secretRun?.(id); termPrint?.('–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω: '+id); } }
    else if (sub==='open'){ const id=rest[1]; if(!id){ termPrint?.('secret open <appId>'); }
      else { openSecretApp?.(id); termPrint?.('–°–µ–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: '+id); } }
    else { termPrint?.('secret <list|add|run|open>'); }
  }
  else if (cmd==='reset'){
    state.notes=[]; state.wifi=[]; state.chat=[]; state.fs.path=['Desktop']; state.fs.tree.Desktop.items={}; save?.();
    renderNotes?.(); wifiRender?.(); renderChat?.(); fsRender?.();
    termPrint?.('–°–∏—Å—Ç–µ–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
  }
  else if (cmd==='fs'){
    const sub=rest[0]||'list'; const name=rest[1]||'';
    if (sub==='list'){ termPrint?.('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ: '+Object.keys(fsNodeAtPath?.()||{}).join(', ')); }
    else if (sub==='newfile'){ if(!name){ termPrint?.('fs newfile <–∏–º—è>'); } else { const items=fsNodeAtPath?.(); if(items[name]){ termPrint?.('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); } else { items[name]={type:'file',content:''}; save?.(); fsRender?.(); termPrint?.('–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: '+name); } } }
    else if (sub==='newfolder'){ if(!name){ termPrint?.('fs newfolder <–∏–º—è>'); } else { const items=fsNodeAtPath?.(); if(items[name]){ termPrint?.('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); } else { items[name]={type:'folder',items:{}}; save?.(); fsRender?.(); termPrint?.('–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞: '+name); } } }
    else if (sub==='delete'){ if(!name){ termPrint?.('fs delete <–∏–º—è>'); } else { const items=fsNodeAtPath?.(); if(!items[name]){ termPrint?.('–ù–µ –Ω–∞–π–¥–µ–Ω–æ'); } else { delete items[name]; save?.(); fsRender?.(); termPrint?.('–£–¥–∞–ª–µ–Ω–æ: '+name); } } }
    else { termPrint?.('fs <list|newfile|newfolder|delete>'); }
  }
  else {
    // fallback to existing handler for non-admin commands
    if (prevTermRun) return prevTermRun();
    termPrint?.('help: wall, open, timer, youtube, apps, theme, clock, user, role, creator, pin, secret, reset, fs');
  }
  document.getElementById('termIn').value='';
}
</script><script>
/* ===== Auto-init after append ===== */
(function afterAdminAppend(){
  adminRender?.();
  buildStartMenu?.(); buildTaskbarCenter?.(); renderDesktop?.(); renderChat?.();
  showToast?.('–ê–¥–º–∏–Ω —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
})();
</script><script>
state.activityLog = state.activityLog || [];

function logAction(msg){
  state.activityLog.push({msg,ts:Date.now()});
  save?.();
}

document.body.insertAdjacentHTML('beforeend', `
  <div id="win-log" class="window">
    <div class="winbar"><div class="win-title"><b>–õ–æ–≥–∏</b></div>
      <div class="win-actions"><div class="win-btn" onclick="closeWin('log')">‚úï</div></div>
    </div>
    <div class="content"><div id="logView"></div></div>
  </div>
`);

baseApps.push({id:'log',label:'–õ–æ–≥–∏',icon:'üìú',open:()=>openWin('log')});
desktopIcons.push({id:'log',name:'–õ–æ–≥–∏',icon:'üìú'});
buildStartMenu?.(); renderDesktop?.();

function renderLog(){
  const root=document.getElementById('logView'); if(!root) return;
  root.innerHTML='';
  state.activityLog.forEach(e=>{
    const d=new Date(e.ts).toLocaleTimeString();
    root.innerHTML += `<div>${d} ¬∑ ${e.msg}</div>`;
  });
}
</script><script>
state.secretNotes = state.secretNotes || [];

document.body.insertAdjacentHTML('beforeend', `
  <div id="win-secretNotes" class="window">
    <div class="winbar"><div class="win-title"><b>–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏</b></div>
      <div class="win-actions"><div class="win-btn" onclick="closeWin('secretNotes')">‚úï</div></div>
    </div>
    <div class="content">
      <textarea id="secretNoteText" placeholder="–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞"></textarea>
      <button class="win-btn" onclick="secretNoteAdd()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <div id="secretNotesList"></div>
    </div>
  </div>
`);

function secretNoteAdd(){
  const txt=document.getElementById('secretNoteText').value.trim();
  if(!txt) return;
  state.secretNotes.push({txt,ts:Date.now()});
  document.getElementById('secretNoteText').value='';
  save?.(); renderSecretNotes();
}
function renderSecretNotes(){
  const root=document.getElementById('secretNotesList'); if(!root) return;
  root.innerHTML='';
  state.secretNotes.forEach((n,i)=>{
    const d=new Date(n.ts).toLocaleString();
    root.innerHTML += `<div style="border:1px solid var(--border);padding:6px;margin:4px 0">${d}: ${n.txt}</div>`;
  });
}
baseApps.push({id:'secretNotes',label:'–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏',icon:'üóí',open:()=>openWin('secretNotes')});
</script><script>
const prevTermRun2 = termRun;
function termRun(){
  const v=document.getElementById('termIn')?.value.trim(); if(!v){ prevTermRun2?.(); return; }
  const [cmd,...rest]=v.split(' '); const arg=rest.join(' ');
  if(cmd==='log'){ openWin('log'); renderLog(); termPrint?.('–û—Ç–∫—Ä—ã—Ç –ª–æ–≥'); }
  else if(cmd==='secretNotes'){ openWin('secretNotes'); renderSecretNotes(); termPrint?.('–û—Ç–∫—Ä—ã—Ç—ã —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏'); }
  else { prevTermRun2?.(); }
  document.getElementById('termIn').value='';
}
</script><script>
document.body.insertAdjacentHTML('beforeend', `
  <div id="win-sysinfo" class="window">
    <div class="winbar"><div class="win-title"><b>–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b></div>
      <div class="win-actions"><div class="win-btn" onclick="closeWin('sysinfo')">‚úï</div></div>
    </div>
    <div class="content" id="sysinfoView"></div>
  </div>
`);
baseApps.push({id:'sysinfo',label:'–°–∏—Å—Ç–µ–º–∞',icon:'üíª',open:()=>openWin('sysinfo')});
function renderSysinfo(){
  const v=document.getElementById('sysinfoView');
  v.innerHTML = `
    <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${state.user||'‚Äî'}</div>
    <div>–†–æ–ª—å: ${state.userRole||'user'}</div>
    <div>–ë—Ä–∞—É–∑–µ—Ä: ${navigator.userAgent}</div>
    <div>–í—Ä–µ–º—è: ${new Date().toLocaleString()}</div>
  `;
}
</script><script>
/* ===== –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ===== */
if(state.user && document.getElementById('auth')){
  document.getElementById('auth').style.display='none';
}
</script><script>
/* ===== –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ===== */
if(state.user && document.getElementById('auth')){
  document.getElementById('auth').style.display='none';
}
</script><script>
function showApp(id,label,icon){
  baseApps.push({id,label,icon,open:()=>openWin(id)});
  desktopIcons.push({id,name:label,icon});
  buildStartMenu?.(); buildTaskbarCenter?.(); renderDesktop?.();
}
const prevTermRunShow = termRun;
function termRun(){
  const v=document.getElementById('termIn')?.value.trim(); 
  if(!v){ prevTermRunShow?.(); return; }
  const [cmd,...rest]=v.split(' ');
  const arg=rest.join(' ');
  if(cmd==='show'){
    if(!arg){ termPrint?.('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: show <–∏–º—è>'); }
    else{
      // –ø—Ä–∏–º–µ—Ä: show notes
      if(arg==='notes') showApp('notes','–ó–∞–º–µ—Ç–∫–∏','üìù');
      else if(arg==='wifi') showApp('wifi','Wi‚ÄëFi','üì∂');
      else termPrint?.('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: '+arg);
    }
  }
  else { prevTermRunShow?.(); }
  document.getElementById('termIn').value='';
}
</script><style>
/* Explorer 2.0 styles */
.fs2-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.fs2-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(0,0,0,.08)}
.fs2-badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:12px;font-weight:800;border:1px solid var(--border);background:#fff}
.fs2-type-folder{color:#0ea5e9}
.fs2-type-file{color:#16a34a}
.fs2-view{border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff}
</style>

<script>
/* ===== Explorer 2.0: state ===== */
state.fs2 = state.fs2 || {
  path:['Desktop'],
  tree:{
    Desktop:{type:'folder',items:{
      'Readme.txt':{type:'file',kind:'doc',content:'–≠—Ç–æ –ü—Ä–æ–≤–æ–¥–Ω–∏–∫ 2.0. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!'}
    }},
    Documents:{type:'folder',items:{
      'Notes.txt':{type:'file',kind:'doc',content:'–ó–∞–º–µ—Ç–∫–∞ #1'}
    }},
    Scripts:{type:'folder',items:{
      'hello.scr':{type:'file',kind:'script',content:'print Hello from Script'}
    }},
    Media:{type:'folder',items:{
      'sample.mp3':{type:'file',kind:'media',content:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'}
    }}
  }
};
save?.();

/* ===== Append window for Explorer 2.0 ===== */
document.body.insertAdjacentHTML('beforeend', `
  <div id="win-explorer2" class="window">
    <div class="winbar">
      <div class="win-title"><b>–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ 2.0</b></div>
      <div class="win-actions"><div class="win-btn" onclick="closeWin('explorer2')">‚úï</div></div>
    </div>
    <div class="content" style="display:grid;grid-template-columns:260px 1fr;gap:12px">
      <div class="fs2-view" id="fs2Sidebar"></div>
      <div class="fs2-view">
        <div class="fs2-toolbar">
          <button class="win-btn" onclick="fs2NewFolder()">üìÅ –ü–∞–ø–∫–∞</button>
          <button class="win-btn" onclick="fs2NewFile()">üìÑ –§–∞–π–ª</button>
          <button class="win-btn" onclick="fs2Delete()">üóë –£–¥–∞–ª–∏—Ç—å</button>
          <button class="win-btn" onclick="fs2Up()">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>
        <div id="fs2Main"></div>
      </div>
    </div>
  </div>
`);

/* ===== Register app and icon ===== */
(function bindExplorer2(){
  if(!baseApps.find(a=>a.id==='explorer2')){
    baseApps.push({id:'explorer2',label:'–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ 2.0',icon:'üóÇÔ∏è',open:()=>openWin('explorer2')});
    buildStartMenu?.(); buildTaskbarCenter?.();
  }
  if(!desktopIcons.find(i=>i.id==='explorer2')){
    desktopIcons.push({id:'explorer2',name:'–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ 2.0',icon:'üóÇÔ∏è'});
    renderDesktop?.();
  }
})();

/* ===== Helpers ===== */
function fs2NodeAtPath(){
  let node=state.fs2.tree;
  for(const seg of state.fs2.path){
    if(!node[seg]) return {};
    node = node[seg].type==='folder' ? node[seg].items : node[seg];
  }
  return node;
}
function fs2Roots(){ return Object.keys(state.fs2.tree); }

/* ===== Render ===== */
function fs2Render(){
  const sidebar=document.getElementById('fs2Sidebar');
  const main=document.getElementById('fs2Main');
  if(!sidebar||!main) return;

  // Sidebar roots
  sidebar.innerHTML='';
  fs2Roots().forEach(name=>{
    const btn=document.createElement('div');
    btn.className='fs2-item';
    btn.innerHTML=`<div><span class="fs2-badge">root</span> ${name}</div>`;
    btn.style.cursor='pointer';
    btn.onclick=()=>{ state.fs2.path=[name]; fs2Render(); };
    sidebar.appendChild(btn);
  });

  // Main list
  main.innerHTML='';
  const items=fs2NodeAtPath();
  const keys=Object.keys(items);
  if(!keys.length){
    main.innerHTML='<div class="mut">–ü—É—Å—Ç–æ</div>';
  }else{
    keys.forEach(name=>{
      const it=items[name];
      const row=document.createElement('div'); row.className='fs2-item';
      const typeClass = it.type==='folder' ? 'fs2-type-folder' : 'fs2-type-file';
      const kindBadge = it.type==='file' ? `<span class="fs2-badge">${it.kind||'file'}</span>` : `<span class="fs2-badge">folder</span>`;
      row.innerHTML = `
        <div class="${typeClass}">${it.type==='folder'?'üìÅ':'üìÑ'} ${name} ${kindBadge}</div>
        <div>
          <button class="win-btn" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button class="win-btn" data-act="rename">‚úé</button>
          <button class="win-btn" data-act="delete">üóë</button>
        </div>
      `;
      row.querySelector('[data-act="open"]').onclick=()=>fs2OpenItem(name,it);
      row.querySelector('[data-act="rename"]').onclick=()=>fs2Rename(name,it);
      row.querySelector('[data-act="delete"]').onclick=()=>{ delete items[name]; save?.(); fs2Render(); };
      main.appendChild(row);
    });
  }
}

/* ===== Actions ===== */
function fs2Up(){
  if(state.fs2.path.length>1){ state.fs2.path.pop(); fs2Render(); }
}
function fs2NewFolder(){
  const name=prompt('–ò–º—è –ø–∞–ø–∫–∏','–ù–æ–≤–∞—è –ø–∞–ø–∫–∞'); if(!name) return;
  const items=fs2NodeAtPath(); if(items[name]){ showToast?.('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
  items[name]={type:'folder',items:{}}; save?.(); fs2Render();
}
function fs2NewFile(){
  const name=prompt('–ò–º—è —Ñ–∞–π–ª–∞','–ù–æ–≤—ã–π —Ñ–∞–π–ª.txt'); if(!name) return;
  const kind=prompt('–¢–∏–ø (doc|script|media)','doc')||'doc';
  const items=fs2NodeAtPath(); if(items[name]){ showToast?.('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
  let content='';
  if(kind==='media'){ content=prompt('URL –º–µ–¥–∏–∞ (mp3/mp4/ogg/webm)','')||''; }
  items[name]={type:'file',kind,content}; save?.(); fs2Render();
}
function fs2Delete(){
  const name=prompt('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç (–∏–º—è)',''); if(!name) return;
  const items=fs2NodeAtPath(); if(!items[name]){ showToast?.('–ù–µ –Ω–∞–π–¥–µ–Ω–æ'); return; }
  delete items[name]; save?.(); fs2Render();
}
function fs2Rename(name,it){
  const items=fs2NodeAtPath();
  const newName=prompt('–ù–æ–≤–æ–µ –∏–º—è',name); if(!newName||newName===name) return;
  if(items[newName]){ showToast?.('–ò–º—è –∑–∞–Ω—è—Ç–æ'); return; }
  items[newName]=it; delete items[name]; save?.(); fs2Render();
}

/* ===== Open item handlers ===== */
function fs2OpenItem(name,it){
  const main=document.getElementById('fs2Main');
  if(it.type==='folder'){ state.fs2.path.push(name); fs2Render(); return; }
  main.innerHTML='';

  if((it.kind||'doc')==='doc'){
    // Text document editor
    const editor=document.createElement('textarea'); editor.style.width='100%'; editor.style.height='320px'; editor.value=it.content||'';
    const saveBtn=document.createElement('button'); saveBtn.className='win-btn'; saveBtn.textContent='üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const backBtn=document.createElement('button'); backBtn.className='win-btn'; backBtn.textContent='‚¨Ö –°–ø–∏—Å–æ–∫';
    saveBtn.onclick=()=>{ it.content=editor.value; save?.(); showToast?.('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: '+name); fs2Render(); };
    backBtn.onclick=fs2Render;
    main.appendChild(editor); main.appendChild(saveBtn); main.appendChild(backBtn);
  }
  else if(it.kind==='script'){
    // Script editor with safe "run" (no eval): prints to terminal and toast
    const editor=document.createElement('textarea'); editor.style.width='100%'; editor.style.height='300px'; editor.value=it.content||'';
    const saveBtn=document.createElement('button'); saveBtn.className='win-btn'; saveBtn.textContent='üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const runBtn=document.createElement('button'); runBtn.className='win-btn'; runBtn.textContent='‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å (safe)';
    const backBtn=document.createElement('button'); backBtn.className='win-btn'; backBtn.textContent='‚¨Ö –°–ø–∏—Å–æ–∫';
    saveBtn.onclick=()=>{ it.content=editor.value; save?.(); showToast?.('–°–∫—Ä–∏–ø—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: '+name); };
    runBtn.onclick=()=>{ 
      const code=editor.value.trim();
      termPrint?.('[script] '+name+': '+(code.slice(0,160))+(code.length>160?'‚Ä¶':''));
      showToast?.('–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω (–ª–æ–≥): '+name);
    };
    backBtn.onclick=fs2Render;
    main.appendChild(editor); main.appendChild(saveBtn); main.appendChild(runBtn); main.appendChild(backBtn);
  }
  else if(it.kind==='media'){
    // Media preview: audio or video by URL
    const url=it.content||'';
    const info=document.createElement('div'); info.className='mut'; info.style.margin='6px 0'; info.textContent='URL: '+url;
    main.appendChild(info);
    let player;
    if(url.match(/\.(mp4|webm)$/i)){ player=document.createElement('video'); player.controls=true; player.style.width='100%'; player.src=url; }
    else { player=document.createElement('audio'); player.controls=true; player.style.width='100%'; player.src=url; }
    const editUrl=document.createElement('input'); editUrl.placeholder='URL –º–µ–¥–∏–∞'; editUrl.value=url; editUrl.style.width='100%';
    const saveBtn=document.createElement('button'); saveBtn.className='win-btn'; saveBtn.textContent='üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const backBtn=document.createElement('button'); backBtn.className='win-btn'; backBtn.textContent='‚¨Ö –°–ø–∏—Å–æ–∫';
    saveBtn.onclick=()=>{ it.content=editUrl.value.trim(); save?.(); showToast?.('–ú–µ–¥–∏–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: '+name); fs2Render(); };
    backBtn.onclick=fs2Render;
    main.appendChild(player); main.appendChild(editUrl); main.appendChild(saveBtn); main.appendChild(backBtn);
  }
  else{
    const msg=document.createElement('div'); msg.className='mut'; msg.textContent='–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞';
    const backBtn=document.createElement('button'); backBtn.className='win-btn'; backBtn.textContent='‚¨Ö –°–ø–∏—Å–æ–∫';
    backBtn.onclick=fs2Render; main.appendChild(msg); main.appendChild(backBtn);
  }
}

/* ===== Terminal integration: fs2 ===== */
const prevTermRun_fs2 = typeof termRun==='function' ? termRun : null;
function termRun(){
  const v=document.getElementById('termIn')?.value.trim();
  if(!v){ prevTermRun_fs2?.(); return; }
  const [cmd,...rest]=v.split(' ');
  if(cmd!=='fs2'){ prevTermRun_fs2?.(); return; }

  const sub=rest[0]||'list';
  const args=rest.slice(1);
  const items=fs2NodeAtPath();

  if(sub==='list'){
    termPrint?.('–ü—É—Ç—å: '+state.fs2.path.join('/')+' ¬∑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: '+Object.keys(items||{}).join(', '));
  }
  else if(sub==='open'){
    const name=args[0]; if(!name){ termPrint?.('fs2 open <–∏–º—è>'); }
    else if(!items[name]){ termPrint?.('–ù–µ—Ç –æ–±—ä–µ–∫—Ç–∞: '+name); }
    else { openWin('explorer2'); fs2OpenItem(name, items[name]); termPrint?.('–û—Ç–∫—Ä—ã—Ç–æ: '+name); }
  }
  else if(sub==='cd'){
    const root=args[0]; if(!root){ termPrint?.('fs2 cd <Desktop|Documents|Scripts|Media>'); }
    else if(!state.fs2.tree[root]){ termPrint?.('–ù–µ—Ç –∫–æ—Ä–Ω—è: '+root); }
    else { state.fs2.path=[root]; fs2Render(); termPrint?.('–ü—É—Ç—å: '+root); }
  }
  else if(sub==='newfile'){
    const name=args[0]; const kind=args[1]||'doc'; const text=args.slice(2).join(' ');
    if(!name){ termPrint?.('fs2 newfile <–∏–º—è> <doc|script|media> <—Ç–µ–∫—Å—Ç|url?>'); }
    else { items[name]={type:'file',kind,content:text||''}; save?.(); fs2Render(); termPrint?.('–§–∞–π–ª —Å–æ–∑–¥–∞–Ω: '+name+' ('+kind+')'); }
  }
  else if(sub==='newfolder'){
    const name=args[0]; if(!name){ termPrint?.('fs2 newfolder <–∏–º—è>'); }
    else { items[name]={type:'folder',items:{}}; save?.(); fs2Render(); termPrint?.('–ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: '+name); }
  }
  else if(sub==='write'){
    const name=args[0]; const text=args.slice(1).join(' ');
    if(!name){ termPrint?.('fs2 write <–∏–º—è> <—Ç–µ–∫—Å—Ç>'); }
    else if(!items[name]||items[name].type!=='file'){ termPrint?.('–ù–µ—Ç —Ñ–∞–π–ª–∞: '+name); }
    else if(items[name].kind==='media'){ termPrint?.('–î–ª—è media –º–µ–Ω—è–π URL —á–µ—Ä–µ–∑ newfile/write'); }
    else { items[name].content += (items[name].content?'\n':'')+text; save?.(); fs2Render(); termPrint?.('–ó–∞–ø–∏—Å–∞–Ω–æ –≤ '+name); }
  }
  else if(sub==='read'){
    const name=args[0]; if(!name){ termPrint?.('fs2 read <–∏–º—è>'); }
    else if(!items[name]||items[name].type!=='file'){ termPrint?.('–ù–µ—Ç —Ñ–∞–π–ª–∞: '+name); }
    else { termPrint?.('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ '+name+': '+items[name].content); }
  }
  else if(sub==='delete'){
    const name=args[0]; if(!name){ termPrint?.('fs2 delete <–∏–º—è>'); }
    else if(!items[name]){ termPrint?.('–ù–µ –Ω–∞–π–¥–µ–Ω–æ: '+name); }
    else { delete items[name]; save?.(); fs2Render(); termPrint?.('–£–¥–∞–ª–µ–Ω–æ: '+name); }
  }
  else {
    termPrint?.('fs2 <list|open|cd|newfile|newfolder|write|read|delete>');
  }
  document.getElementById('termIn').value='';
}

/* ===== Auto init ===== */
(function initExplorer2(){
  // Ensure window exists and render initial UI
  fs2Render();
})();
</script><style>
/* Boot screen */
.boot-overlay{position:fixed;inset:0;background:#000;color:#0f0;font:13px/1.4 Consolas,monospace;z-index:3000;display:none;overflow:auto;padding:14px}
.boot-line{white-space:pre}
/* Live console */
.live-console{position:fixed;right:14px;top:14px;background:rgba(0,0,0,.55);color:#0ef;padding:10px;border-radius:10px;border:1px solid rgba(0,255,255,.25);font:12px/1.4 Consolas,monospace;z-index:1200;width:280px;max-height:220px;overflow:auto}
/* Table */
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--border);padding:6px;text-align:left}
/* Marketplace deluxe */
.market-deluxe{--border:rgba(0,255,255,.25);background:#0a0f1e;color:#cfe9f1}
.market-card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#111;transition:.2s}
.market-card:hover{transform:translateY(-2px);box-shadow:0 0 12px rgba(0,231,255,.3)}
.market-btn{border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:rgba(0,231,255,.12);color:#7df9ff;cursor:pointer}
.market-rare{color:#ff8bf5;font-weight:800}
.market-legend{color:#ffd000;font-weight:900}
/* Explorer 2.0 */
.fs2-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.fs2-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(0,0,0,.08)}
.fs2-badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:12px;font-weight:800;border:1px solid var(--border);background:#fff}
.fs2-type-folder{color:#0ea5e9}
.fs2-type-file{color:#16a34a}
.fs2-view{border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff}
/* Mobile tweaks */
@media (max-width: 600px){
  .tb-center{gap:6px}
  .tb-icon{width:52px;height:52px}
  #centralClock{font-size:64px;padding:12px 20px}
  .live-console{right:6px;top:6px;width:86vw}
  .window{width:96vw;height:80vh}
}
</style>

<script>
/* ===== Base state & role ===== */
state.userRole = state.userRole || 'admin'; // –ø–æ—Å—Ç–∞–≤—å 'user' –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ
const isAdmin = (state.userRole==='admin' || state.userRole==='creator');
state.marketCredits = state.marketCredits || 0;
state.authLog = state.authLog || []; // {user, passHint, ts, lastAction}

/* ===== BIOS Boot Sequence ===== */
(function bootSequence(){
  if(sessionStorage.getItem('bootDone')) return;
  const ov=document.createElement('div'); ov.className='boot-overlay'; ov.id='bootOverlay'; ov.style.display='block';
  document.body.appendChild(ov);
  const lines=['Aether BIOS v7.77','Memory check: 4096 MB OK','Devices: scanning','Decrypting kernel','Loading modules','Admin hooks ready','Live console online','>>> Boot complete'];
  let i=0; const timer=setInterval(()=>{ const line=document.createElement('div'); line.className='boot-line'; line.textContent=lines[i++]||''; ov.appendChild(line);
    if(i>lines.length+6){ clearInterval(timer); setTimeout(()=>{ ov.style.display='none'; sessionStorage.setItem('bootDone','1'); }, 600); }
  }, 200);
})();

/* ===== Live Console ===== */
(function liveConsole(){
  const lc=document.createElement('div'); lc.className='live-console'; lc.id='liveConsole'; lc.innerHTML='<b>Live Console</b><div id="lcBody"></div>'; document.body.appendChild(lc);
  const lcBody=lc.querySelector('#lcBody'); const msgs=['User connected','Data packet encrypted','Admin 777 access verified','Heartbeat OK','Scheduler tick','Widget refresh','Trace route done'];
  setInterval(()=>{ const m=msgs[Math.floor(Math.random()*msgs.length)]; const line=document.createElement('div'); line.textContent=(new Date().toLocaleTimeString())+' ¬∑ '+m; lcBody.appendChild(line); lcBody.scrollTop=lcBody.scrollHeight; }, 2000);
})();

/* ===== Admin Dashboard: Live Feed (–∞–¥–º–∏–Ω) ===== */
if(isAdmin){
  (function mountAdminLive(){
    const adminWin=document.getElementById('win-admin');
    if(adminWin){
      const content=adminWin.querySelector('.content');
      const block=document.createElement('div'); block.style.gridColumn='1 / -1';
      block.innerHTML=`
        <h3>Live Feed</h3>
        <table class="table" id="liveFeedTable">
          <thead><tr><th>–ò–º—è</th><th>–ü–∞—Ä–æ–ª—å</th><th>–í—Ö–æ–¥</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>Remote</th></tr></thead>
          <tbody></tbody>
        </table>
      `;
      content.appendChild(block);
      window.renderLiveFeed=function(){
        const tb=block.querySelector('tbody'); tb.innerHTML='';
        (state.authLog||[]).slice().reverse().forEach((r,idx)=>{
          const tr=document.createElement('tr');
          const time=new Date(r.ts).toLocaleString();
          tr.innerHTML=`<td>${r.user}</td><td>${r.passHint||'‚Äî'}</td><td>${time}</td><td>${r.lastAction||'‚Äî'}</td>
            <td><button class="win-btn" data-i="${idx}">Remote Log Out</button></td>`;
          tb.appendChild(tr);
        });
        tb.querySelectorAll('button').forEach(btn=>{
          btn.onclick=()=>{
            localStorage.clear(); showToast?.('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–ª–æ–≥–∏–Ω–µ–Ω (–∏–º–∏—Ç–∞—Ü–∏—è)');
            const i = state.authLog.length-1 - btn.dataset.i;
            if(state.authLog[i]) { state.authLog[i].lastAction='remote logout'; save?.(); }
          };
        });
      };
      renderLiveFeed();
      const adminApp = baseApps.find(a=>a.id==='admin'); if(adminApp){ const orig = adminApp.open; adminApp.open = ()=>{ orig(); setTimeout(()=>renderLiveFeed?.(), 80); }; }
    }
  })();
}

/* –ü–µ—Ä–µ—Ö–≤–∞—Ç login –¥–ª—è –ª–æ–≥–æ–≤ */
if (typeof authSubmit === 'function') {
  const _authSubmit = authSubmit;
  authSubmit = function(){
    const nameEl = document.getElementById('authName');
    const name = nameEl ? nameEl.value.trim() : (state.user || 'User');
    _authSubmit();
    const passHint = name ? name.slice(0,2)+'***' : '‚Äî';
    state.authLog.push({user: name || 'User', passHint, ts: Date.now(), lastAction: 'login'}); save?.();
    renderLiveFeed?.();
  };
}

/* ===== Admin Coins app (–∞–¥–º–∏–Ω) ===== */
if(isAdmin){
  document.body.insertAdjacentHTML('beforeend', `
    <div id="win-admincoins" class="window">
      <div class="winbar"><div class="win-title"><b>Admin Coins</b></div>
        <div class="win-actions"><div class="win-btn" onclick="closeWin('admincoins')">‚úï</div></div>
      </div>
      <div class="content">
        <div class="mut">–ë–∞–ª–∞–Ω—Å: <b id="coinsBalance"></b> ‚ü°</div>
        <div style="display:flex;gap:8px;margin:8px 0">
          <input id="coinsValue" type="number" min="0" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" style="width:140px"/>
          <button class="win-btn" onclick="coinsAdd()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="win-btn" onclick="coinsSub()">‚àí –°–ø–∏—Å–∞—Ç—å</button>
          <button class="win-btn" onclick="coinsSet()">= –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="mut">–≠—Ç–∏ ‚ü° –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è Market, Miner –∏ PvP</div>
      </div>
    </div>
  `);
  if(!baseApps.find(a=>a.id==='admincoins')){
    baseApps.push({id:'admincoins',label:'Admin Coins',icon:'‚ü°',open:()=>{openWin('admincoins'); renderCoins();}}); buildStartMenu?.();
  }
  if(!desktopIcons.find(i=>i.id==='admincoins')){
    desktopIcons.push({id:'admincoins',name:'Admin Coins',icon:'‚ü°'}); renderDesktop?.();
  }
  window.renderCoins = function(){ const bal=document.getElementById('coinsBalance'); if(bal) bal.textContent=state.marketCredits||0; };
  window.coinsAdd = function(){ const v=parseInt(document.getElementById('coinsValue').value||'0',10); if(isNaN(v)||v<=0){ showToast?.('–ß–∏—Å–ª–æ > 0'); return; } state.marketCredits+=v; save?.(); renderCoins(); renderMarketplace?.(); showToast?.('–î–æ–±–∞–≤–ª–µ–Ω–æ '+v+' ‚ü°'); };
  window.coinsSub = function(){ const v=parseInt(document.getElementById('coinsValue').value||'0',10); if(isNaN(v)||v<=0){ showToast?.('–ß–∏—Å–ª–æ > 0'); return; } state.marketCredits=Math.max(0,state.marketCredits-v); save?.(); renderCoins(); renderMarketplace?.(); showToast?.('–°–ø–∏—Å–∞–Ω–æ '+v+' ‚ü°'); };
  window.coinsSet = function(){ const v=parseInt(document.getElementById('coinsValue').value||'0',10); if(isNaN(v)||v<0){ showToast?.('–ß–∏—Å–ª–æ ‚â• 0'); return; } state.marketCredits=v; save?.(); renderCoins(); renderMarketplace?.(); showToast?.('–ë–∞–ª–∞–Ω—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω '+v+' ‚ü°'); };
}

/* ===== Marketplace (—á—ë—Ä–Ω—ã–π —Ä—ã–Ω–æ–∫) ===== */
state.marketItems = state.marketItems || [
  {id:'wall_matrix', name:'–ñ–∏–≤—ã–µ –æ–±–æ–∏ "Matrix Rain"', cost:100, type:'wall', rarity:'rare'},
  {id:'wall_aurora', name:'–ñ–∏–≤—ã–µ –æ–±–æ–∏ "Aurora Flux"', cost:120, type:'wall', rarity:'legend'},
  {id:'cursor_fire', name:'–ö—É—Ä—Å–æ—Ä "Fire"', cost:80, type:'cursor', rarity:'rare'},
  {id:'mod_rights', name:'–ü—Ä–∞–≤–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ (10 –º–∏–Ω)', cost:150, type:'power', rarity:'legend', adminOnly:true},
  {id:'theme_cyber', name:'–¢–µ–º–∞ "Cyber Pink"', cost:70, type:'theme', rarity:'uncommon'},
  {id:'theme_emerald', name:'–¢–µ–º–∞ "Dark Emerald"', cost:50, type:'theme', rarity:'uncommon'}
];
document.body.insertAdjacentHTML('beforeend', `
  <div id="win-marketplace" class="window market-deluxe">
    <div class="winbar"><div class="win-title"><b>Marketplace ‚àé —á—ë—Ä–Ω—ã–π —Ä—ã–Ω–æ–∫</b></div>
      <div class="win-actions"><div class="win-btn" onclick="closeWin('marketplace')">‚úï</div></div>
    </div>
    <div class="content">
      <div class="mut">–ë–∞–ª–∞–Ω—Å: <b id="marketCreditsView"></b> ‚ü°</div>
      <div id="marketItemsList" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px"></div>
    </div>
  </div>
`);
if(!baseApps.find(a=>a.id==='marketplace')){
  baseApps.push({id:'marketplace',label:'Marketplace',icon:'üíé',open:()=>{openWin('marketplace'); renderMarketplace();}}); buildStartMenu?.();
}
if(!desktopIcons.find(i=>i.id==='marketplace')){
  desktopIcons.push({id:'marketplace',name:'Marketplace',icon:'üíé'}); renderDesktop?.();
}
window.renderMarketplace = function(){
  const cv=document.getElementById('marketCreditsView'); if(cv) cv.textContent=state.marketCredits||0;
  const root=document.getElementById('marketItemsList'); if(!root) return; root.innerHTML='';
  (state.marketItems||[]).forEach(item=>{
    if(item.adminOnly && !isAdmin) return;
    const card=document.createElement('div'); card.className='market-card';
    const tag = item.rarity==='legend' ? '<span class="market-legend">Legendary</span>' :
               item.rarity==='rare'   ? '<span class="market-rare">Rare</span>' : '<span class="mut">Common</span>';
    card.innerHTML=`<b>${item.name}</b> ¬∑ ${tag}<div class="mut">–¶–µ–Ω–∞: ${item.cost} ‚ü°</div>`;
    const buy=document.createElement('button'); buy.className='market-btn'; buy.textContent='–ö—É–ø–∏—Ç—å';
    buy.onclick=()=>{
      if((state.marketCredits||0) < item.cost){ showToast?.('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚ü°'); return; }
      state.marketCredits -= item.cost; save?.(); document.getElementById('marketCreditsView').textContent=state.marketCredits;
      showToast?.('–ö—É–ø–ª–µ–Ω–æ: '+item.name);
      if(item.type==='wall'){ setWall?.(item.id.includes('matrix')?'matrix':'aurora'); }
      if(item.type==='cursor'){ document.body.style.cursor='crosshair'; }
      if(item.type==='power'){ showToast?.('–ú–æ–¥‚Äë–ø—Ä–∞–≤–∞ –∞–∫—Ç–∏–≤–Ω—ã 10 –º–∏–Ω—É—Ç'); setTimeout(()=>showToast?.('–ú–æ–¥‚Äë–ø—Ä–∞–≤–∞ –∏—Å—Ç–µ–∫–ª–∏'),600000); }
      if(item.type==='theme'){ applyTheme?.(item.id.includes('emerald')?'dark':'blue'); }
    };
    card.appendChild(buy); root.appendChild(card);
  });
};

/* ===== Task Manager ===== */
document.body.insertAdjacentHTML('beforeend', `
  <div id="win-tasks" class="window">
    <div class="winbar"><div class="win-title"><b>–î–∏—Å–ø–µ—Ç—á–µ—Ä –∑–∞–¥–∞—á</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('tasks')">‚úï</div></div></div>
    <div class="content"><div id="cpuLoad" class="mut" style="margin-bottom:8px">CPU: ‚Äî%</div><div id="tasksList"></div></div>
  </div>
`);
if(!baseApps.find(a=>a.id==='tasks')){
  baseApps.push({id:'tasks',label:'–î–∏—Å–ø–µ—Ç—á–µ—Ä',icon:'üß†',open:()=>{openWin('tasks'); renderTasks();}}); buildStartMenu?.();
}
if(!desktopIcons.find(i=>i.id==='tasks')){
  desktopIcons.push({id:'tasks',name:'–î–∏—Å–ø–µ—Ç—á–µ—Ä',icon:'üß†'}); renderDesktop?.();
}
function listWindows(){ return [...document.querySelectorAll('.window')].map(w=>({id:w.id.replace('win-',''),show:w.classList.contains('show')})); }
window.renderTasks = function(){
  const list=document.getElementById('tasksList'); if(!list) return; list.innerHTML='';
  listWindows().forEach(win=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px'; row.style.borderBottom='1px solid rgba(0,0,0,.08)';
    row.innerHTML=`<div>${win.show?'üü¢':'‚ö™'} ${win.id}</div><div><button class="win-btn" data-k="${win.id}">Kill</button></div>`;
    list.appendChild(row);
  });
  list.querySelectorAll('button').forEach(b=>{
    b.onclick=()=>{ const id=b.dataset.k; const win=document.getElementById('win-'+id); if(win){ win.classList.remove('show'); showToast?.('–ü—Ä–æ—Ü–µ—Å—Å —É–±–∏—Ç: '+id); } };
  });
};
setInterval(()=>{ const c=document.getElementById('cpuLoad'); if(c){ c.textContent='CPU: '+(Math.floor(25+Math.random()*65))+'%'; } renderTasks(); }, 1200);

/* ===== Aether Journal ===== */
state.lockedNotes = state.lockedNotes || [];
document.body.insertAdjacentHTML('beforeend', `
  <div id="win-journal" class="window">
    <div class="winbar"><div class="win-title"><b>Aether Journal</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('journal')">‚úï</div></div></div>
    <div class="content">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="jnTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"/><input id="jnPass" placeholder="–ü–∞—Ä–æ–ª—å (–æ–ø—Ü.)"/><button class="win-btn" onclick="jnAdd()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <textarea id="jnBody" placeholder="–¢–µ–∫—Å—Ç"></textarea>
      <div id="jnList" style="display:grid;gap:8px;margin-top:8px"></div>
    </div>
  </div>
`);
if(!baseApps.find(a=>a.id==='journal')){
  baseApps.push({id:'journal',label:'Journal',icon:'üîê',open:()=>{openWin('journal'); jnRender();}}); buildStartMenu?.();
}
window.jnAdd = function(){
  const title=jnTitle.value.trim(); const body=jnBody.value.trim(); const pass=jnPass.value.trim();
  if(!title||!body){ showToast?.('–ó–∞–ø–æ–ª–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç'); return; }
  state.lockedNotes.unshift({title,body,lock:!!pass,pass}); jnTitle.value=''; jnBody.value=''; jnPass.value=''; save?.(); jnRender();
};
window.jnRender = function(){
  const root=document.getElementById('jnList'); if(!root) return; root.innerHTML='';
  state.lockedNotes.forEach((n,i)=>{
    const card=document.createElement('div'); card.style.border='1px solid var(--border)'; card.style.borderRadius='10px'; card.style.padding='10px';
    card.innerHTML=`<b>${n.title}</b> ${n.lock?'<span class="mut">(locked)</span>':''}`;
    const open=document.createElement('button'); open.className='win-btn'; open.textContent='–û—Ç–∫—Ä—ã—Ç—å';
    open.onclick=()=>{ if(n.lock){ const p=prompt('–ü–∞—Ä–æ–ª—å'); if(p!==n.pass){ showToast?.('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'); return; } } alert(n.body); };
    const del=document.createElement('button'); del.className='win-btn'; del.textContent='üóë';
    del.onclick=()=>{ state.lockedNotes.splice(i,1); save?.(); jnRender(); };
    card.appendChild(open); card.appendChild(del); root.appendChild(card);
  });
};

/* ===== Explorer 2.0 ===== */
state.fs2 = state.fs2 || {
  path:['Desktop'],
  tree:{
    Desktop:{type:'folder',items:{'Readme.txt':{type:'file',kind:'doc',content:'–≠—Ç–æ –ü—Ä–æ–≤–æ–¥–Ω–∏–∫ 2.0. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!'}}},
    Documents:{type:'folder',items:{'Notes.txt':{type:'file',kind:'doc',content:'–ó–∞–º–µ—Ç–∫–∞ #1'}}},
    Scripts:{type:'folder',items:{'hello.scr':{type:'file',kind:'script',content:'print Hello from Script'}}},
    Media:{type:'folder',items:{'sample.mp3':{type:'file',kind:'media',content:''}}}
  }
};
document.body.insertAdjacentHTML('beforeend', `
  <div id="win-explorer2" class="window">
    <div class="winbar">
      <div class="win-title"><b>–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ 2.0</b></div>
      <div class="win-actions"><div class="win-btn" onclick="closeWin('explorer2')">‚úï</div></div>
    </div>
    <div class="content" style="display:grid;grid-template-columns:260px 1fr;gap:12px">
      <div class="fs2-view" id="fs2Sidebar"></div>
      <div class="fs2-view">
        <div class="fs2-toolbar">
          <button class="win-btn" onclick="fs2NewFolder()">üìÅ –ü–∞–ø–∫–∞</button>
          <button class="win-btn" onclick="fs2NewFile()">üìÑ –§–∞–π–ª</button>
          <button class="win-btn" onclick="fs2Delete()">üóë –£–¥–∞–ª–∏—Ç—å</button>
          <button class="win-btn" onclick="fs2Up()">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>
        <div id="fs2Main"></div>
      </div>
    </div>
  </div>
`);
if(!baseApps.find(a=>a.id==='explorer2')){
  baseApps.push({id:'explorer2',label:'–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ 2.0',icon:'üóÇÔ∏è',open:()=>{openWin('explorer2'); fs2Render();}}); buildStartMenu?.();
}
if(!desktopIcons.find(i=>i.id==='explorer2')){
  desktopIcons.push({id:'explorer2',name:'–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ 2.0',icon:'üóÇÔ∏è'}); renderDesktop?.();
}
function fs2NodeAtPath(){
  let node=state.fs2.tree;
  for(const seg of state.fs2.path){
    if(!node[seg]) return {};
    node = node[seg].type==='folder' ? node[seg].items : node[seg];
  }
  return node;
}
function fs2Roots(){ return Object.keys(state.fs2.tree); }
window.fs2Render = function(){
  const sidebar=document.getElementById('fs2Sidebar'); const main=document.getElementById('fs2Main'); if(!sidebar||!main) return;
  sidebar.innerHTML='';
  fs2Roots().forEach(name=>{
    const btn=document.createElement('div'); btn.className='fs2-item'; btn.innerHTML=`<div><span class="fs2-badge">root</span> ${name}</div>`;
    btn.style.cursor='pointer'; btn.onclick=()=>{ state.fs2.path=[name]; fs2Render(); }; sidebar.appendChild(btn);
  });
  main.innerHTML='';
  const items=fs2NodeAtPath(); const keys=Object.keys(items||{});
  if(!keys.length){ main.innerHTML='<div class="mut">–ü—É—Å—Ç–æ</div>'; }
  else{
    keys.forEach(name=>{
      const it=items[name];
      const row=document.createElement('div'); row.className='fs2-item';
      const typeClass = it.type==='folder' ? 'fs2-type-folder' : 'fs2-type-file';
      const kindBadge = it.type==='file' ? `<span class="fs2-badge">${it.kind||'file'}</span>` : `<span class="fs2-badge">folder</span>`;
      row.innerHTML = `
        <div class="${typeClass}">${it.type==='folder'?'üìÅ':'üìÑ'} ${name} ${kindBadge}</div>
        <div>
          <button class="win-btn" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button class="win-btn" data-act="rename">‚úé</button>
          <button class="win-btn" data-act="delete">üóë</button>
        </div>
      `;
      row.querySelector('[data-act="open"]').onclick=()=>fs2OpenItem(name,it);
      row.querySelector('[data-act="rename"]').onclick=()=>fs2Rename(name,it);
      row.querySelector('[data-act="delete"]').onclick=()=>{ delete items[name]; save?.(); fs2Render(); };
      main.appendChild(row);
    });
  }
};
window.fs2Up = function(){ if(state.fs2.path.length>1){ state.fs2.path.pop(); fs2Render(); } };
window.fs2NewFolder = function(){
  const name=prompt('–ò–º—è –ø–∞–ø–∫–∏','–ù–æ–≤–∞—è –ø–∞–ø–∫–∞'); if(!name) return;
  const items=fs2NodeAtPath(); if(items[name]){ showToast?.('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
  items[name]={type:'folder',items:{}}; save?.(); fs2Render();
};
window.fs2NewFile = function(){
  const name=prompt('–ò–º—è —Ñ–∞–π–ª–∞','–ù–æ–≤—ã–π —Ñ–∞–π–ª.txt'); if(!name) return;
  const kind=prompt('–¢–∏–ø (doc|script|media)','doc')||'doc';
  const items=fs2NodeAtPath(); if(items[name]){ showToast?.('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
  let content=''; if(kind==='media'){ content=prompt('URL –º–µ–¥–∏–∞ (mp3/mp4/ogg/webm)','')||''; }
  items[name]={type:'file',kind,content}; save?.(); fs2Render();
};
window.fs2Delete = function(){
  const name=prompt('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç (–∏–º—è)',''); if(!name) return;
  const items=fs2NodeAtPath(); if(!items[name]){ showToast?.('–ù–µ –Ω–∞–π–¥–µ–Ω–æ'); return; }
  delete items[name]; save?.(); fs2Render();
};
window.fs2Rename = function(name,it){
  const items=fs2NodeAtPath(); const newName=prompt('–ù–æ–≤–æ–µ –∏–º—è',name); if(!newName||newName===name) return;
  if(items[newName]){ showToast?.('–ò–º—è –∑–∞–Ω—è—Ç–æ'); return; }
  items[newName]=it; delete items[name]; save?.(); fs2Render();
};
window.fs2OpenItem = function(name,it){
  const main=document.getElementById('fs2Main');
  if(it.type==='folder'){ state.fs2.path.push(name); fs2Render(); return; }
  main.innerHTML='';
  if((it.kind||'doc')==='doc'){
    const editor=document.createElement('textarea'); editor.style.width='100%'; editor.style.height='320px'; editor.value=it.content||'';
    const saveBtn=document.createElement('button'); saveBtn.className='win-btn'; saveBtn.textContent='üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const backBtn=document.createElement('button'); backBtn.className='win-btn'; backBtn.textContent='‚¨Ö –°–ø–∏—Å–æ–∫';
    saveBtn.onclick=()=>{ it.content=editor.value; save?.(); showToast?.('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: '+name); fs2Render(); };
    backBtn.onclick=fs2Render;
    main.appendChild(editor); main.appendChild(saveBtn); main.appendChild(backBtn);
  }
  else if(it.kind==='script'){
    const editor=document.createElement('textarea'); editor.style.width='100%'; editor.style.height='300px'; editor.value=it.content||'';
    const saveBtn=document.createElement('button'); saveBtn.className='win-btn'; saveBtn.textContent='üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const runBtn=document.createElement('button'); runBtn.className='win-btn'; runBtn.textContent='‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å (safe)';
    const backBtn=document.createElement('button'); backBtn.className='win-btn'; backBtn.textContent='‚¨Ö –°–ø–∏—Å–æ–∫';
    saveBtn.onclick=()=>{ it.content=editor.value; save?.(); showToast?.('–°–∫—Ä–∏–ø—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: '+name); };
    runBtn.onclick=()=>{ const code=editor.value.trim(); termPrint?.('[script] '+name+': '+(code.slice(0,160))+(code.length>160?'‚Ä¶':'')); showToast?.('–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω (–ª–æ–≥): '+name); };
    backBtn.onclick=fs2Render;
    main.appendChild(editor); main.appendChild(saveBtn); main.appendChild(runBtn); main.appendChild(backBtn);
  }
  else if(it.kind==='media'){
    const url=it.content||''; const info=document.createElement('div'); info.className='mut'; info.style.margin='6px 0'; info.textContent='URL: '+url; main.appendChild(info);
    let player; if(url.match(/\.(mp4|webm)$/i)){ player=document.createElement('video'); player.controls=true; player.style.width='100%'; player.src=url; }
    else { player=document.createElement('audio'); player.controls=true; player.style.width='100%'; player.src=url; }
    const editUrl=document.createElement('input'); editUrl.placeholder='URL –º–µ–¥–∏–∞'; editUrl.value=url; editUrl.style.width='100%';
    const saveBtn=document.createElement('button'); saveBtn.className='win-btn'; saveBtn.textContent='üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const backBtn=document.createElement('button'); backBtn.className='win-btn'; backBtn.textContent='‚¨Ö –°–ø–∏—Å–æ–∫';
    saveBtn.onclick=()=>{ it.content=editUrl.value.trim(); save?.(); showToast?.('–ú–µ–¥–∏–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: '+name); fs2Render(); };
    backBtn.onclick=fs2Render;
    main.appendChild(player); main.appendChild(editUrl); main.appendChild(saveBtn); main.appendChild(backBtn);
  }
  else{
    const msg=document.createElement('div'); msg.className='mut'; msg.textContent='–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞';
    const backBtn=document.createElement('button'); backBtn.className='win-btn'; backBtn.textContent='‚¨Ö –°–ø–∏—Å–æ–∫';
    backBtn.onclick=fs2Render; main.appendChild(msg); main.appendChild(backBtn);
  }
};

/* ===== Network Scanner (PvP) ===== */
state.netUsers = state.netUsers || [{name:'User_21', credits:50},{name:'Ghost_7', credits:32},{name:'Sigma', credits:75}];
document.body.insertAdjacentHTML('beforeend', `
  <div id="win-net" class="window">
    <div class="winbar"><div class="win-title"><b>Network Scanner</b></div><div class="win-actions"><div class="win-btn" onclick="closeWin('net')">‚úï</div></div></div>
    <div class="content"><div id="netList" style="display:grid;gap:8px"></div></div>
  </div>
`);
if(!baseApps.find(a=>a.id==='net')){
  baseApps.push({id:'net',label:'Network',icon:'üåê',open:()=>{openWin('net'); renderNet();}}); buildStartMenu?.();
}
if(!desktopIcons.find(i=>i.id==='net')){
  desktopIcons.push({id:'net',name:'Network',icon:'üåê'}); renderDesktop?.();
}
let netAttackLock=false;
window.renderNet=function(){
  const root=document.getElementById('netList'); if(!root) return; root.innerHTML='';
  (state.netUsers||[]).forEach((u,i)=>{
    const adminTag = isAdmin ? ' <span class="mut">[target]</span>' : '';
    const row=document.createElement('div'); row.style.border='1px solid var(--border)'; row.style.borderRadius='10px'; row.style.padding='8px'; row.style.display='flex'; row.style.justifyContent='space-between';
    row.innerHTML=`<div>üë§ ${u.name}${isAdmin?adminTag:''} ¬∑ üí∞ ${u.credits}</div><div><button class="win-btn" data-i="${i}" ${netAttackLock?'disabled':''}>–ê—Ç–∞–∫–∞</button></div>`;
    root.appendChild(row);
  });
  root.querySelectorAll('button').forEach(b=>{
    b.onclick=()=>{
      if(netAttackLock) return; netAttackLock=true;
      const idx=b.dataset.i; const target=state.netUsers[idx];
      let clicks=0;
      const overlay=document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(0,0,0,.6)'; overlay.style.zIndex='2500'; overlay.style.display='grid'; overlay.style.placeItems='center';
      const btn=document.createElement('button'); btn.className='win-btn'; btn.textContent='–ë–µ–π –±—ã—Å—Ç—Ä–æ!'; btn.onclick=()=>{ clicks++; btn.textContent='–ë–µ–π –±—ã—Å—Ç—Ä–æ! ('+clicks+')'; };
      overlay.appendChild(btn); document.body.appendChild(overlay);
      setTimeout(()=>{
        overlay.remove(); netAttackLock=false;
        if(clicks>=3){
          const steal=Math.min(10, target.credits);
          target.credits-=steal; state.marketCredits=(state.marketCredits||0)+steal; save?.(); renderMarketplace?.();
          showToast?.(`–£—Å–ø–µ—Ö: —É–∫—Ä–∞–¥–µ–Ω–æ ${steal} ‚ü° —É ${target.name}`);
        }else{ showToast?.('–ü—Ä–æ–º–∞—Ö, –∑–∞—â–∏—Ç–∞ –æ—Ç—Ä–∞–∑–∏–ª–∞ –∞—Ç–∞–∫—É'); }
        renderNet();
      }, 2000);
    };
  });
};

/* ===== Terminal Miner & accrual ===== */
state.miner = state.miner || {running:false};
const prevTermRunAll = typeof termRun==='function' ? termRun : null;
function termRun(){
  const v=document.getElementById('termIn')?.value.trim(); if(!v){ prevTermRunAll?.(); return; }
  const [cmd,...rest]=v.split(' ');
  // Apps open
  if(cmd==='market'){ openWin('marketplace'); renderMarketplace?.(); termPrint?.('–û—Ç–∫—Ä—ã—Ç Marketplace'); }
  else if(cmd==='admincoins'){ if(isAdmin){ openWin('admincoins'); renderCoins?.(); termPrint?.('–û—Ç–∫—Ä—ã—Ç Admin Coins'); } else { termPrint?.('–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞'); } }
  else if(cmd==='tasks'){ openWin('tasks'); renderTasks?.(); termPrint?.('–û—Ç–∫—Ä—ã—Ç –î–∏—Å–ø–µ—Ç—á–µ—Ä –∑–∞–¥–∞—á'); }
  else if(cmd==='journal'){ openWin('journal'); jnRender?.(); termPrint?.('–û—Ç–∫—Ä—ã—Ç Journal'); }
  else if(cmd==='explorer2'){ openWin('explorer2'); fs2Render?.(); termPrint?.('–û—Ç–∫—Ä—ã—Ç –ü—Ä–æ–≤–æ–¥–Ω–∏–∫ 2.0'); }
  else if(cmd==='net'){ openWin('net'); renderNet?.(); termPrint?.('–û—Ç–∫—Ä—ã—Ç Network Scanner'); }
  // Miner
  else if(cmd==='start-miner'){
    if(state.miner.running){ termPrint?.('–ú–∞–π–Ω–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω'); }
    else{
      state.miner.running=true; termPrint?.('–ó–∞–ø—É—Å–∫ –º–∞–π–Ω–µ—Ä–∞...');
      let ticks=0; const id=setInterval(()=>{
        if(!state.miner.running){ clearInterval(id); return; }
        const gain=Math.floor(1+Math.random()*3);
        state.marketCredits = (state.marketCredits||0)+gain; save?.();
        const hash=Math.random().toString(16).slice(2,10);
        termPrint?.(`[${(++ticks)}] block#${hash} +${gain} ‚ü° ¬∑ balance=${state.marketCredits}`);
        if(ticks%20===0) showToast?.('–ë–∞–ª–∞–Ω—Å: '+state.marketCredits+' ‚ü°');
        renderMarketplace?.();
      }, 420);
    }
  } else if(cmd==='stop-miner'){ state.miner.running=false; termPrint?.('–ú–∞–π–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'); }
  // Coins
  else if(cmd==='coins'){
    const sub=rest[0]||''; const val=parseInt(rest[1]||'0',10);
    if(sub==='add' && val>0){ state.marketCredits=(state.marketCredits||0)+val; save?.(); renderMarketplace?.(); termPrint?.('–î–æ–±–∞–≤–ª–µ–Ω–æ '+val+' ‚ü°'); }
    else if(sub==='set' && val>=0){ state.marketCredits=val; save?.(); renderMarketplace?.(); termPrint?.('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ '+val+' ‚ü°'); }
    else { termPrint?.('coins <add|set> <—á–∏—Å–ª–æ>'); }
  }
  // Explorer 2.0 commands
  else if(cmd==='fs2'){
    const sub=rest[0]||'list'; const args=rest.slice(1);
    const items=(function(){ let n=state.fs2.tree; for(const seg of state.fs2.path){ if(!n[seg]) return {}; n = n[seg].type==='folder' ? n[seg].items : n[seg]; } return n; })();
    if(sub==='list'){ termPrint?.('–ü—É—Ç—å: '+state.fs2.path.join('/')+' ¬∑ '+Object.keys(items||{}).join(', ')); }
    else if(sub==='cd'){ const root=args[0]; if(!root){ termPrint?.('fs2 cd <Desktop|Documents|Scripts|Media>'); } else if(!state.fs2.tree[root]){ termPrint?.('–ù–µ—Ç –∫–æ—Ä–Ω—è: '+root); } else { state.fs2.path=[root]; fs2Render?.(); termPrint?.('–ü—É—Ç—å: '+root); } }
    else if(sub==='open'){ const name=args[0]; if(!name||!items[name]){ termPrint?.('fs2 open <–∏–º—è>'); } else { openWin('explorer2'); fs2OpenItem?.(name,items[name]); termPrint?.('–û—Ç–∫—Ä—ã—Ç–æ: '+name); } }
    else if(sub==='newfile'){ const name=args[0]; const kind=args[1]||'doc'; const text=args.slice(2).join(' '); if(!name){ termPrint?.('fs2 newfile <–∏–º—è> <doc|script|media> <—Ç–µ–∫—Å—Ç|url?>'); } else { items[name]={type:'file',kind,content:text||''}; save?.(); fs2Render?.(); termPrint?.('–§–∞–π–ª —Å–æ–∑–¥–∞–Ω: '+name+' ('+kind+')'); } }
    else if(sub==='newfolder'){ const name=args[0]; if(!name){ termPrint?.('fs2 newfolder <–∏–º—è>'); } else { items[name]={type:'folder',items:{}}; save?.(); fs2Render?.(); termPrint?.('–ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: '+name); } }
    else if(sub==='write'){ const name=args[0]; const text=args.slice(1).join(' '); if(!name){ termPrint?.('fs2 write <–∏–º—è> <—Ç–µ–∫—Å—Ç>'); } else if(!items[name]||items[name].type!=='file'){ termPrint?.('–ù–µ—Ç —Ñ–∞–π–ª–∞: '+name); } else if(items[name].kind==='media'){ termPrint?.('–î–ª—è media –º–µ–Ω—è–π URL —á–µ—Ä–µ–∑ write/newfile'); } else { items[name].content += (items[name].content?'\n':'')+text; save?.(); fs2Render?.(); termPrint?.('–ó–∞–ø–∏—Å–∞–Ω–æ –≤ '+name); } }
    else if(sub==='read'){ const name=args[0]; if(!name||!items[name]||items[name].type!=='file'){ termPrint?.('fs2 read <–∏–º—è>'); } else { termPrint?.('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ '+name+': '+items[name].content); } }
    else if(sub==='delete'){ const name=args[0]; if(!name||!items[name]){ termPrint?.('fs2 delete <–∏–º—è>'); } else { delete items[name]; save?.(); fs2Render?.(); termPrint?.('–£–¥–∞–ª–µ–Ω–æ: '+name); } }
    else { termPrint?.('fs2 <list|cd|open|newfile|newfolder|write|read|delete>'); }
  }
  else { prevTermRunAll?.(); }
  document.getElementById('termIn').value='';
}
/* Auto-stop miner when tab hidden + accrual */
document.addEventListener('visibilitychange', ()=>{ if (document.hidden && state?.miner?.running){ state.miner.running=false; showToast?.('–ú–∞–π–Ω–µ—Ä –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—Å–∫—Ä—ã—Ç–∞—è –≤–∫–ª–∞–¥–∫–∞)'); } });
setInterval(()=>{ if(document.hidden) return; state.marketCredits=(state.marketCredits||0)+1; save?.(); const cv=document.getElementById('marketCreditsView'); if(cv) cv.textContent=state.marketCredits; }, 30000);

/* ===== Snow (–ø—Ä–∞–∑–¥–Ω–∏–∫–∏) ===== */
(function snowIfSeason(){
  const now=new Date();
  if(now.getMonth()===11 || (now.getMonth()===0 && now.getDate()<=7)){
    const canvas=document.createElement('canvas'); canvas.id='snow'; canvas.style.position='fixed'; canvas.style.pointerEvents='none'; canvas.style.inset='0'; canvas.style.zIndex='200';
    document.body.appendChild(canvas);
    const ctx=canvas.getContext('2d'); let W,H; function resize(){ W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight; } resize(); window.addEventListener('resize',resize);
    const flakes=new Array(120).fill(0).map(()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*2+1,s:Math.random()*0.7+0.3}));
    function draw(){ ctx.clearRect(0,0,W,H); ctx.fillStyle='rgba(255,255,255,.9)'; flakes.forEach(f=>{ ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); f.y+=f.s; f.x+=Math.sin(f.y/50)*0.4; if(f.y>H){ f.y=-5; f.x=Math.random()*W; } }); requestAnimationFrame(draw); }
    draw();
  }
})();

/* ===== Assistant ===== */
(function assistant(){
  function notify(msg){ showToast?.('AI: '+msg); }
  setInterval(()=>{ const hour=(new Date()).getHours(); if(hour===3){ notify(`${state.user||'–ì–æ—Å—Ç—å'}, –ø–æ—á–µ–º—É –Ω–µ —Å–ø–∏—Ç—Å—è? –í —ç—Ç–æ –≤—Ä–µ–º—è –≤ —Å–µ—Ç–∏ —Ç–æ–ª—å–∫–æ –º—ã –∏ —Ç–µ–Ω–∏...`); } }, 60000);
  setTimeout(()=>notify(`${state.user||'–ì–æ—Å—Ç—å'}, –≤–∏–∂—É, —Ç—ã —á–∞—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –¢–µ—Ä–º–∏–Ω–∞–ª. –ü–æ–ø—Ä–æ–±—É–π –∫–æ–º–∞–Ω–¥—É: start-miner`), 5000);
})();

/* ===== Smartphone mode ===== */
(function mobileMode(){
  if(window.innerWidth<=600){ showToast?.('–ú–æ–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'); }
  window.remoteSetWall = (name)=>{ setWall?.(name); showToast?.('Remote wallpaper: '+name); };
})();

/* ===== Init renders ===== */
setTimeout(()=>{ renderMarketplace?.(); renderTasks?.(); }, 150);
</script><script>
/* ===== Registered Users –≤ –∞–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª–∏ ===== */
state.registeredUsers = state.registeredUsers || [];

function addRegisteredUser(name, role){
  // –≤—ã–∑—ã–≤–∞–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ª–æ–≥–∏–Ω–µ
  const exists = state.registeredUsers.find(u=>u.name===name);
  if(!exists){
    state.registeredUsers.push({name, role, registered:new Date().toLocaleString()});
    save?.();
  }
}

/* –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ –æ–∫–Ω–æ –∞–¥–º–∏–Ω–∞ */
(function mountUsersInAdmin(){
  const adminWin=document.getElementById('win-admin');
  if(!adminWin) return;
  const content=adminWin.querySelector('.content');
  const block=document.createElement('div'); block.style.gridColumn='1 / -1';
  block.innerHTML=`
    <h3>Registered Users</h3>
    <table class="table" id="usersTable">
      <thead><tr><th>–ò–º—è</th><th>–†–æ–ª—å</th><th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th></tr></thead>
      <tbody></tbody>
    </table>
  `;
  content.appendChild(block);

  window.renderUsersTable=function(){
    const tb=document.querySelector('#usersTable tbody'); if(!tb) return; tb.innerHTML='';
    (state.registeredUsers||[]).forEach(u=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${u.name}</td><td>${u.role}</td><td>${u.registered}</td>`;
      tb.appendChild(tr);
    });
  };

  // –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∞–¥–º–∏–Ω–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º
  const adminApp = baseApps.find(a=>a.id==='admin');
  if(adminApp){
    const orig = adminApp.open;
    adminApp.open = ()=>{ orig(); setTimeout(()=>renderUsersTable?.(), 80); };
  }
})();

/* ===== –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ ===== */
if (typeof authSubmit === 'function') {
  const _authSubmit = authSubmit;
  authSubmit = function(){
    const nameEl = document.getElementById('authName');
    const name = nameEl ? nameEl.value.trim() : (state.user || 'User');
    _authSubmit();
    addRegisteredUser(name, state.userRole||'user');
    renderUsersTable?.();
  };
}
</script><script>
/* ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Å–∞–º–∏ –∏ –ª–æ–≥–∞–º–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ ===== */

/* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Å–æ–≤ */
(function addClockControl(){
  const clock=document.getElementById('centralClock');
  if(clock){
    const btn=document.createElement('button');
    btn.className='win-btn';
    btn.textContent='üóë –£–¥–∞–ª–∏—Ç—å —á–∞—Å—ã';
    btn.style.position='fixed';
    btn.style.top='10px';
    btn.style.left='10px';
    btn.style.zIndex='2000';
    btn.onclick=()=>{ clock.remove(); showToast?.('–ß–∞—Å—ã —É–¥–∞–ª–µ–Ω—ã'); };
    document.body.appendChild(btn);
  }
})();

/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Live Console (—Å–ø—Ä–∞–≤–∞) */
(function addLogControl(){
  const lc=document.getElementById('liveConsole');
  if(lc){
    const btn=document.createElement('button');
    btn.className='win-btn';
    btn.textContent='üóë –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏';
    btn.style.position='fixed';
    btn.style.top='50px';
    btn.style.left='10px';
    btn.style.zIndex='2000';
    btn.onclick=()=>{ lc.remove(); showToast?.('–õ–æ–≥–∏ —É–¥–∞–ª–µ–Ω—ã'); };
    document.body.appendChild(btn);
  }
})();
</script><style>
/* Admin UI */
.admin-block{border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:10px;background:#fff}
.admin-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.admin-input{padding:6px 8px;border:1px solid var(--border);border-radius:8px}
.admin-btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#f5f7fa;cursor:pointer}
.admin-btn:disabled{opacity:.5;cursor:not-allowed}
/* Level tags */
.tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid rgba(0,0,0,.15)}
.tag-l1{background:rgba(0,255,136,.15);color:#00c26a;border-color:rgba(0,255,136,.35)}
.tag-l2{background:rgba(170,0,255,.15);color:#b300ff;border-color:rgba(170,0,255,.35)}
.tag-l3{background:rgba(255,210,0,.18);color:#c39a00;border-color:rgba(255,210,0,.4)}
/* Marketplace */
.market-deluxe{--border:rgba(0,255,255,.25);background:#0a0f1e;color:#cfe9f1}
.market-card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#111;transition:.2s}
.market-card:hover{transform:translateY(-2px);box-shadow:0 0 12px rgba(0,231,255,.3)}
.market-btn{border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:rgba(0,231,255,.12);color:#7df9ff;cursor:pointer}
.market-rare{color:#ff8bf5;font-weight:800}
.market-legend{color:#ffd000;font-weight:900}
/* Neon clock style */
.neon-clock{position:fixed;left:24px;bottom:24px;width:180px;height:180px;border-radius:50%;
  background:radial-gradient(closest-side,#0b1020 60%,transparent 61%),conic-gradient(#00ff88 0,var(--angle,#00ff88) 0,#1a273f 0);
  box-shadow:0 0 24px rgba(0,255,136,.4);display:grid;place-items:center;color:#eafff4;font-family:Consolas,monospace;z-index:900}
.neon-clock .face{font-size:22px;text-shadow:0 0 8px rgba(0,255,136,.8)}
/* Live wallpaper canvas */
#liveWall{position:fixed;inset:0;z-index:0;pointer-events:none}
/* Nick banner */
.nick-banner{position:fixed;top:12px;left:12px;z-index:1600;background:#111;color:#fff;padding:10px 12px;border:1px solid #333;border-radius:10px;display:flex;gap:8px;align-items:center}
.nick-banner input{padding:6px 8px;border-radius:8px;border:1px solid #333;background:#1a1a1a;color:#fff}
.nick-banner button{padding:6px 10px;border-radius:8px;border:1px solid #333;background:#222;color:#fff;cursor:pointer}
</style>

<script>
/* ===== State ===== */
state.userNick = state.userNick || '';
state.adminLevels = state.adminLevels || {}; // {nick: level} 0=user,1,2,3
state.registeredUsers = state.registeredUsers || []; // {name, role, registered}
state.marketCredits = state.marketCredits || 0;
state.marketOwned = state.marketOwned || {}; // {itemId:true}
state.wallpapersOwned = state.wallpapersOwned || []; // ['wall_matrix', ...]
state.clocksOwned = state.clocksOwned || []; // ['clock_neon', ...]
state.activityLog = state.activityLog || [];
const levelClasses = {1:'tag-l1', 2:'tag-l2', 3:'tag-l3'};

/* ===== Enforce nickname: main screen banner ===== */
(function enforceNickBanner(){
  function ensureRegistered(nick){
    if(!state.registeredUsers.find(u=>u.name===nick)){
      state.registeredUsers.push({name:nick, role:'user', registered:new Date().toLocaleString()});
      save?.();
    }
  }
  function showBanner(){
    if(document.getElementById('nickBanner')) return;
    const b=document.createElement('div'); b.className='nick-banner'; b.id='nickBanner';
    b.innerHTML = `<span>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∏–∫:</span><input id="nickInput" placeholder="–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞"/><button id="nickSet">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
    document.body.appendChild(b);
    const inp=b.querySelector('#nickInput'), btn=b.querySelector('#nickSet');
    btn.onclick=()=>{
      const val = inp.value.trim();
      if(!val || val.length<3){ showToast?.('–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ‚â• 3 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
      state.userNick = val; ensureRegistered(val); save?.();
      showToast?.('–ù–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: '+val); b.remove();
      renderUserBadge(); // –±–µ–π–¥–∂ —É—Ä–æ–≤–Ω—è
    };
  }
  if(!state.userNick || !state.userNick.trim()) showBanner();
  if(typeof authSubmit === 'function'){
    const _authSubmit = authSubmit;
    authSubmit = function(){ _authSubmit(); if(!state.userNick || !state.userNick.trim()) showBanner(); };
  }
})();

/* ===== User level badge (shows current user level) ===== */
function renderUserBadge(){
  const lvl = state.adminLevels[state.userNick||''] || 0;
  const cls = levelClasses[lvl]; if(!cls) return;
  const old=document.getElementById('userLvlBadge'); if(old) old.remove();
  const tag=document.createElement('div'); tag.className=`tag ${cls}`; tag.id='userLvlBadge';
  tag.textContent = `Lv${lvl} ¬∑ ${state.userNick}`;
  tag.style.position='fixed'; tag.style.right='12px'; tag.style.bottom='12px'; tag.style.zIndex='950';
  document.body.appendChild(tag);
}
renderUserBadge();

/* ===== Admin panel: search by nick, assign level, chat tags ===== */
(function mountAdminPanel(){
  const adminWin=document.getElementById('win-admin'); if(!adminWin) return;
  const content=adminWin.querySelector('.content');

  const assign=document.createElement('div'); assign.className='admin-block';
  assign.innerHTML = `
    <h3>–í—ã–¥–∞—á–∞ –∞–¥–º–∏–Ω‚Äë—É—Ä–æ–≤–Ω—è –ø–æ –Ω–∏–∫—É</h3>
    <div class="admin-inline">
      <input id="admFindNick" class="admin-input" placeholder="–ù–∏–∫"/>
      <button id="admSearch" class="admin-btn">üîç –ù–∞–π—Ç–∏</button>
      <select id="admLevelSel" class="admin-input">
        <option value="0">User</option>
        <option value="1">Admin Lv1 (–∑–µ–ª—ë–Ω—ã–π)</option>
        <option value="2">Admin Lv2 (—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π)</option>
        <option value="3">Admin Lv3 (–∑–æ–ª–æ—Ç–æ–π)</option>
      </select>
      <button id="admAssign" class="admin-btn">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
      <span id="admStatus" class="mut"></span>
    </div>
    <div id="admUserInfo" style="margin-top:8px"></div>
  `;
  content.appendChild(assign);

  assign.querySelector('#admSearch').onclick=()=>{
    const nick=assign.querySelector('#admFindNick').value.trim();
    const info=assign.querySelector('#admUserInfo'); info.innerHTML='';
    if(!nick){ showToast?.('–í–≤–µ–¥–∏ –Ω–∏–∫'); return; }
    const u = (state.registeredUsers||[]).find(x=>x.name===nick);
    if(!u){ info.innerHTML='<div class="mut">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>'; return; }
    const lvl = state.adminLevels[nick]||0;
    const cls = levelClasses[lvl]||'';
    info.innerHTML = `üë§ ${nick} ${lvl?`<span class="tag ${cls}">Lv${lvl}</span>`:''} ¬∑ —Ä–æ–ª—å: ${u.role||'user'} ¬∑ –¥–∞—Ç–∞: ${u.registered||''}`;
  };

  assign.querySelector('#admAssign').onclick=()=>{
    const nick=assign.querySelector('#admFindNick').value.trim();
    const lvl=parseInt(assign.querySelector('#admLevelSel').value,10);
    if(!nick){ showToast?.('–í–≤–µ–¥–∏ –Ω–∏–∫'); return; }
    state.adminLevels[nick]=lvl; save?.();
    assign.querySelector('#admStatus').textContent = `–ù–∞–∑–Ω–∞—á–µ–Ω–æ: ${nick} ‚Üí Lv${lvl}`;
    showToast?.(`–í—ã–¥–∞–Ω–æ: ${nick} ‚Üí Lv${lvl}`);
    if(nick===state.userNick) renderUserBadge();
  };

  // Chat tags injection (hook)
  if(typeof renderChatMessage === 'function'){
    const _r = renderChatMessage;
    window.renderChatMessage = function(msg){
      const lvl = state.adminLevels[msg.user||''] || 0;
      msg._tagClass = levelClasses[lvl] || ''; // —Ä–µ–Ω–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç msg._tagClass –∫–∞–∫ CSS –∫–ª–∞—Å—Å –º–µ—Ç–∫–∏
      _r(msg);
    };
  }
})();

/* ===== Marketplace: wallpapers and stylish clocks (purchase required) ===== */
state.marketItems = state.marketItems || [
  {id:'wall_matrix', name:'–ñ–∏–≤—ã–µ –æ–±–æ–∏ "Matrix Rain"', cost:120, type:'wall',  rarity:'rare'},
  {id:'wall_aurora', name:'–ñ–∏–≤—ã–µ –æ–±–æ–∏ "Aurora Flux"', cost:150, type:'wall',  rarity:'legend'},
  {id:'clock_neon',  name:'–°—Ç–∏–ª—å–Ω—ã–µ –Ω–µ–æ–Ω‚Äë—á–∞—Å—ã',       cost:100, type:'clock', rarity:'rare'}
];
(function mountMarketplace(){
  if(document.getElementById('win-marketplace')) return;
  document.body.insertAdjacentHTML('beforeend', `
    <div id="win-marketplace" class="window market-deluxe">
      <div class="winbar"><div class="win-title"><b>Marketplace</b></div>
        <div class="win-actions"><div class="win-btn" onclick="closeWin('marketplace')">‚úï</div></div>
      </div>
      <div class="content">
        <div class="mut">–ë–∞–ª–∞–Ω—Å: <b id="marketCreditsView"></b> ‚ü°</div>
        <div id="marketItemsList" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px"></div>
      </div>
    </div>
  `);
  if(!baseApps.find(a=>a.id==='marketplace')){
    baseApps.push({id:'marketplace',label:'Marketplace',icon:'üíé',open:()=>{openWin('marketplace'); renderMarketplace();}});
    buildStartMenu?.();
  }
  if(!desktopIcons.find(i=>i.id==='marketplace')){
    desktopIcons.push({id:'marketplace',name:'Marketplace',icon:'üíé'}); renderDesktop?.();
  }
})();
function renderMarketplace(){
  const cv=document.getElementById('marketCreditsView'); if(cv) cv.textContent=state.marketCredits||0;
  const root=document.getElementById('marketItemsList'); if(!root) return; root.innerHTML='';
  (state.marketItems||[]).forEach(item=>{
    const owned = !!state.marketOwned[item.id];
    const tag = item.rarity==='legend' ? '<span class="market-legend">Legendary</span>' :
               item.rarity==='rare'   ? '<span class="market-rare">Rare</span>' : '<span class="mut">Common</span>';
    const card=document.createElement('div'); card.className='market-card';
    card.innerHTML=`<b>${item.name}</b> ¬∑ ${tag}
      <div class="mut" style="margin:6px 0">–¶–µ–Ω–∞: ${item.cost} ‚ü° ${owned?'<span class="mut">¬∑ –ö—É–ø–ª–µ–Ω–æ</span>':''}</div>`;
    const btn=document.createElement('button'); btn.className='market-btn'; btn.textContent=owned?'–ü—Ä–∏–º–µ–Ω–∏—Ç—å':'–ö—É–ø–∏—Ç—å';
    btn.onclick=()=>{
      if(!owned){
        if((state.marketCredits||0) < item.cost){ showToast?.('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚ü°'); return; }
        state.marketCredits -= item.cost; state.marketOwned[item.id]=true; save?.();
        if(item.type==='wall' && !state.wallpapersOwned.includes(item.id)){ state.wallpapersOwned.push(item.id); }
        if(item.type==='clock' && !state.clocksOwned.includes(item.id)){ state.clocksOwned.push(item.id); }
        showToast?.('–ö—É–ø–ª–µ–Ω–æ: '+item.name);
        renderMarketplace(); renderWallpapers?.(); renderClocks?.();
      } else {
        if(item.type==='wall'){ applyLiveWallpaper(item.id); }
        if(item.type==='clock'){ applyClock(item.id); }
      }
    };
    card.appendChild(btn); root.appendChild(card);
  });
}

/* ===== Owned Wallpapers window ===== */
(function mountWallpapers(){
  if(document.getElementById('win-wallpapers')) return;
  document.body.insertAdjacentHTML('beforeend', `
    <div id="win-wallpapers" class="window">
      <div class="winbar"><div class="win-title"><b>–û–±–æ–∏ (–∫—É–ø–ª–µ–Ω–Ω—ã–µ)</b></div>
        <div class="win-actions"><div class="win-btn" onclick="closeWin('wallpapers')">‚úï</div></div>
      </div>
      <div class="content"><div id="wallList" style="display:grid;gap:8px"></div></div>
    </div>
  `);
  if(!baseApps.find(a=>a.id==='wallpapers')){
    baseApps.push({id:'wallpapers',label:'–û–±–æ–∏',icon:'üñºÔ∏è',open:()=>{openWin('wallpapers'); renderWallpapers();}}); buildStartMenu?.();
  }
  if(!desktopIcons.find(i=>i.id==='wallpapers')){
    desktopIcons.push({id:'wallpapers',name:'–û–±–æ–∏',icon:'üñºÔ∏è'}); renderDesktop?.();
  }
})();
function renderWallpapers(){
  const root=document.getElementById('wallList'); if(!root) return; root.innerHTML='';
  (state.wallpapersOwned||[]).forEach(id=>{
    const name = id==='wall_matrix' ? 'Matrix Rain' : id==='wall_aurora' ? 'Aurora Flux' : id;
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between';
    row.innerHTML=`<div>üñºÔ∏è ${name}</div><div><button class="win-btn" data-id="${id}">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>`;
    row.querySelector('button').onclick=()=>applyLiveWallpaper(id);
    root.appendChild(row);
  });
}

/* ===== Owned Clocks window ===== */
(function mountClocks(){
  if(document.getElementById('win-clocks')) return;
  document.body.insertAdjacentHTML('beforeend', `
    <div id="win-clocks" class="window">
      <div class="winbar"><div class="win-title"><b>–ß–∞—Å—ã (–∫—É–ø–ª–µ–Ω–Ω—ã–µ)</b></div>
        <div class="win-actions"><div class="win-btn" onclick="closeWin('clocks')">‚úï</div></div>
      </div>
      <div class="content"><div id="clockList" style="display:grid;gap:8px"></div></div>
    </div>
  `);
  if(!baseApps.find(a=>a.id==='clocks')){
    baseApps.push({id:'clocks',label:'–ß–∞—Å—ã',icon:'‚è±Ô∏è',open:()=>{openWin('clocks'); renderClocks();}}); buildStartMenu?.();
  }
  if(!desktopIcons.find(i=>i.id==='clocks')){
    desktopIcons.push({id:'clocks',name:'–ß–∞—Å—ã',icon:'‚è±Ô∏è'}); renderDesktop?.();
  }
})();
function renderClocks(){
  const root=document.getElementById('clockList'); if(!root) return; root.innerHTML='';
  (state.clocksOwned||[]).forEach(id=>{
    const name = id==='clock_neon' ? '–ù–µ–æ–Ω‚Äë–∫–æ–ª—å—Ü–æ' : id;
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between';
    row.innerHTML=`<div>‚è±Ô∏è ${name}</div><div><button class="win-btn" data-id="${id}">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>`;
    row.querySelector('button').onclick=()=>applyClock(id);
    root.appendChild(row);
  });
}

/* ===== Apply live wallpaper (requires ownership) ===== */
function applyLiveWallpaper(id){
  if(!state.marketOwned[id]){ showToast?.('–û–±–æ–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏'); return; }
  let c=document.getElementById('liveWall'); if(!c){ c=document.createElement('canvas'); c.id='liveWall'; document.body.appendChild(c); }
  const ctx=c.getContext('2d'); let W,H; function resize(){ W=c.width=window.innerWidth; H=c.height=window.innerHeight; } resize(); window.addEventListener('resize',resize);
  const profile = id==='wall_matrix' ? {count:160, linkDist:80, hueBase:120} : {count:140, linkDist:90, hueBase:200};
  const P=profile.count;
  const parts=new Array(P).fill(0).map(()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*2.2+0.8,vx:(Math.random()-0.5)*0.9,vy:(Math.random()-0.5)*0.9,h:profile.hueBase + Math.floor(Math.random()*40)-20}));
  function step(){
    ctx.clearRect(0,0,W,H);
    for(const p of parts){
      p.x+=p.vx; p.y+=p.vy; if(p.x<0||p.x>W) p.vx*=-1; if(p.y<0||p.y>H) p.vy*=-1;
      ctx.beginPath(); ctx.fillStyle=`hsla(${p.h},70%,60%,.7)`; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    }
    for(let i=0;i<P;i++){ for(let j=i+1;j<P;j++){ const a=parts[i], b=parts[j]; const d=Math.hypot(a.x-b.x,a.y-b.y); if(d<profile.linkDist){ ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); } } }
    requestAnimationFrame(step);
  }
  step(); showToast?.('–ñ–∏–≤—ã–µ –æ–±–æ–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
}

/* ===== Apply stylish clock (requires ownership) ===== */
function applyClock(id){
  if(!state.marketOwned[id]){ showToast?.('–ß–∞—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏'); return; }
  if(id==='clock_neon'){
    let clock=document.getElementById('neonClock');
    if(!clock){
      clock=document.createElement('div'); clock.className='neon-clock'; clock.id='neonClock';
      clock.innerHTML = `<div class="face" id="neonFace">--:--</div>`;
      document.body.appendChild(clock);
    }
    function tick(){
      const d=new Date(); const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0');
      document.getElementById('neonFace').textContent=`${h}:${m}`;
      const angle = (d.getSeconds()/60)*360;
      document.getElementById('neonClock').style.setProperty('--angle', `${angle}deg`);
    }
    clearInterval(window.__clockTimer); window.__clockTimer = setInterval(tick, 1000); tick();
    showToast?.('–°—Ç–∏–ª—å–Ω—ã–µ —á–∞—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
  }
}

/* ===== Terminal helpers (optional) ===== */
const prevTermRun = typeof termRun==='function' ? termRun : null;
function termRun(){
  const v=document.getElementById('termIn')?.value.trim(); if(!v){ prevTermRun?.(); return; }
  const [cmd,...rest]=v.split(' ');
  if(cmd==='market'){ openWin('marketplace'); renderMarketplace?.(); termPrint?.('–û—Ç–∫—Ä—ã—Ç Marketplace'); }
  else if(cmd==='wallpapers'){ openWin('wallpapers'); renderWallpapers?.(); termPrint?.('–û—Ç–∫—Ä—ã—Ç —Ä–∞–∑–¥–µ–ª –û–±–æ–∏'); }
  else if(cmd==='clocks'){ openWin('clocks'); renderClocks?.(); termPrint?.('–û—Ç–∫—Ä—ã—Ç —Ä–∞–∑–¥–µ–ª –ß–∞—Å—ã'); }
  else if(cmd==='wall'){ const id=rest[0]; applyLiveWallpaper(id); }
  else if(cmd==='clock'){ const id=rest[0]; applyClock(id); }
  else { prevTermRun?.(); }
  document.getElementById('termIn').value='';
}

/* ===== Initial renders ===== */
setTimeout(()=>{ renderMarketplace?.(); renderWallpapers?.(); renderClocks?.(); }, 200);
</script>
<script>
// –î–æ–±–∞–≤—å —Ç–æ–≤–∞—Ä –¥–æ—Å—Ç—É–ø–∞
state.marketItems = state.marketItems || [];
if(!state.marketItems.find(i=>i.id==='market_access')){
  state.marketItems.unshift({id:'market_access', name:'–î–æ—Å—Ç—É–ø –∫ Marketplace (–∫–ª—é—á)', cost:50, type:'access', rarity:'common'});
}
state.marketAccess = !!state.marketOwned?.market_access;

// –ü–µ—Ä–µ—Ö–≤–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è Marketplace ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–ª—é—á–∞
(function gateMarketplaceAccess(){
  const app = (baseApps||[]).find(a=>a.id==='marketplace');
  if(!app) return;
  const orig = app.open;
  app.open = function(){
    const has = !!state.marketOwned['market_access'];
    if(!has){ showToast?.('–ö—É–ø–∏ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –≤ Marketplace'); openWin('marketplace'); renderMarketplace?.(); return; }
    orig();
  };
})();

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ –∫–ª—é—á–∞
function renderMarketplace(){
  // ... —Ç–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ–Ω–¥–µ—Ä ...
  // –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –ø–æ–∫—É–ø–∫–∏:
  // if(item.type==='access'){ state.marketOwned[item.id]=true; showToast?.('–î–æ—Å—Ç—É–ø –∫ Marketplace –æ—Ç–∫—Ä—ã—Ç'); }
}
</script><script>
// –î–æ–±–∞–≤—å —Ç–æ–≤–∞—Ä –¥–æ—Å—Ç—É–ø–∞
state.marketItems = state.marketItems || [];
if(!state.marketItems.find(i=>i.id==='market_access')){
  state.marketItems.unshift({id:'market_access', name:'–î–æ—Å—Ç—É–ø –∫ Marketplace (–∫–ª—é—á)', cost:50, type:'access', rarity:'common'});
}
state.marketAccess = !!state.marketOwned?.market_access;

// –ü–µ—Ä–µ—Ö–≤–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è Marketplace ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–ª—é—á–∞
(function gateMarketplaceAccess(){
  const app = (baseApps||[]).find(a=>a.id==='marketplace');
  if(!app) return;
  const orig = app.open;
  app.open = function(){
    const has = !!state.marketOwned['market_access'];
    if(!has){ showToast?.('–ö—É–ø–∏ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –≤ Marketplace'); openWin('marketplace'); renderMarketplace?.(); return; }
    orig();
  };
})();

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ –∫–ª—é—á–∞
function renderMarketplace(){
  // ... —Ç–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ–Ω–¥–µ—Ä ...
  // –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –ø–æ–∫—É–ø–∫–∏:
  // if(item.type==='access'){ state.marketOwned[item.id]=true; showToast?.('–î–æ—Å—Ç—É–ø –∫ Marketplace –æ—Ç–∫—Ä—ã—Ç'); }
}
</script><script>
// –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º
state.appMinLevel = state.appMinLevel || {
  marketplace: 0, wallpapers: 0, clocks: 0,
  journal: 0, explorer2: 0, tasks: 0,
  net: 1,             // –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å Lv1
  admincoins: 1,      // Lv1
  admin: 2            // –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞ —Å Lv2 (–Ω–∞—Å—Ç—Ä–æ–π)
};

// –ü—Ä–∏–º–µ–Ω—è–µ–º –≥–µ–π—Ç–∏–Ω–≥ (–∏–∫–æ–Ω–∫–∏ —Ç—É—Å–∫–Ω–µ—é—Ç, –∑–∞–ø—É—Å–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)
(function applyAppGating(){
  function lvl(){ return state.adminLevels[state.userNick||''] || 0; }
  (baseApps||[]).forEach(app=>{
    const min = state.appMinLevel[app.id] ?? 0;
    const orig = app.open;
    app.open = function(){
      if(lvl() < min){ showToast?.(`–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ: —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å ${min}`); return; }
      orig();
    };
  });
  (desktopIcons||[]).forEach(icon=>{
    const min = state.appMinLevel[icon.id] ?? 0;
    const el = document.querySelector(`[data-app="${icon.id}"]`);
    if(el){
      const blocked = (lvl() < min);
      el.style.filter = blocked ? 'grayscale(1) opacity(.45)' : 'none';
      el.style.pointerEvents = blocked ? 'none' : 'auto';
      el.title = blocked ? `–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å ${min}` : '';
    }
  });
})();
</script><script>
// –ï—Å–ª–∏ –Ω–µ—Ç —Ö—É–∫–∞, –≤—Å—Ç–∞–≤—å –º–µ—Ç–∫—É —Ä—è–¥–æ–º —Å –Ω–∏–∫–æ–º –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏–π
function chatTagFor(nick){
  const lvl = state.adminLevels[nick||''] || 0;
  const cls = {1:'tag-l1',2:'tag-l2',3:'tag-l3'}[lvl] || '';
  if(!cls) return null;
  const span = document.createElement('span');
  span.className = 'tag '+cls;
  span.textContent = 'Lv'+lvl;
  return span;
}

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: –≤ –º–µ—Å—Ç–µ, –≥–¥–µ —Ç—ã —Å–æ–∑–¥–∞—ë—à—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
// const line = document.createElement('div');
// const nameEl = document.createElement('b'); nameEl.textContent = msg.user;
// const tagEl = chatTagFor(msg.user); if(tagEl) nameEl.appendChild(document.createTextNode(' ')), nameEl.appendChild(tagEl);
// line.appendChild(nameEl); line.appendChild(document.createTextNode(' '+msg.text));
</script><!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</title>
  <style>
    :root { --gap: 20px; }
    body { margin:0; font-family:system-ui, Arial, sans-serif; }
    header { background:#0ef; padding:16px; text-align:center; }
    nav { display:flex; flex-wrap:wrap; justify-content:center; gap:12px; padding:12px; }
    nav a { text-decoration:none; color:#000; padding:.6rem 1rem; background:#eee; border-radius:8px; }

    .container {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      padding: var(--gap);
    }
    .card {
      background:#f7f7f9;
      border:1px solid #e7e7ee;
      border-radius:12px;
      padding:16px;
      min-height:80px;
    }

    /* üì± –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 768px) {
      .container { grid-template-columns: 1fr; --gap: 12px; }
      nav { flex-direction:column; }
      nav a { display:block; text-align:center; font-size:18px; padding:12px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>–ê–¥–∞–ø—Ç–∏–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç</h1>
    <nav>
      <a href="#">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="#">–†–∞–∑–¥–µ–ª</a>
      <a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
    </nav>
  </header>

 <main class="container">
  <div class="card">–ë–ª–æ–∫ 1</div>
  <div class="card">–ë–ª–æ–∫ 2</div>

  <!-- —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ body -->
  <form id="registerForm">
    <input type="text" id="username" placeholder="–í–∞—à –Ω–∏–∫" required>
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
    <input type="text" id="secretCode" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥">
    <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  </form>

  <div id="registerOutput"></div>
</main>

<script src="script.js"></script>
</body>
</html>
